---
title: "guesser_knower_battery"
author: "Flore Luttmann"
date: "2025-07-15"
output: html_document
---

#Preliminaries
### Load libraries and custom functions
```{r}
rm(list=ls())    #clean the workspace
library(car)
library(tidyverse) 
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
library(lme4)
library(summarytools)
library(emmeans)
library(lmerTest)
library(forcats)
library(seqtest)
library(corrplot)
library(scales)
library(patchwork)
library(conflicted)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("recode", "dplyr")
source("functions/diagnostic_fcns.r")    
source("functions/glmm_stability.r") 
source("functions/boot_glmm.r") 
```

### Import data
```{r}
xdata <- read_delim(file.choose(), delim = ",", locale = locale(decimal_mark = "."))
       #chose the data file you want to analyse

#number of excluded trials
sum(is.na(xdata$choice_binary)) #9
#number of trials in 1st session
sum(!is.na(xdata$choice_binary) & xdata$session == 1) #2224
#number of trials in 1st session
sum(!is.na(xdata$choice_binary) & xdata$session == 2) #2087
#number of no choice
sum(xdata$no_choice == 1, na.rm = TRUE) #29
#number of irrelevant choice
sum(xdata$irrelevant_choice == 1, na.rm = TRUE) #114

xdata <- xdata %>%
  mutate(dog_id = as.factor(dog_id),
           condition = as.factor(condition)) %>% 
    filter(!is.na(choice_binary)) %>%  # Remove the excluded trials
    droplevels()

which(is.na(xdata$choice_binary)) #double check for NAs
```
###Inspect data
```{r}
str(xdata)

#split data of 2 sessions
session1<-xdata %>% 
  filter(session==1) %>% 
  droplevels()

session2<-xdata %>% 
  filter(session==2) %>% 
  droplevels()



length(unique(levels(session1$dog_id))) #93 dogs tested in session 1
length(unique(levels(session2$dog_id))) # of which only 87 came back for session 2
```

#Descriptive stats
###Sample size
```{r}
#We use the fonction size.cor in seqtest (Yanagida,2016) with alpha=0,05 ; beta = 0,2 (80%power) ; minimum effect of interest = 0,3
size.cor(delta = 0.3, 
         alpha = 0.05, 
         beta = 0.2, 
         alternative = "two.sided")

#Minimum sample size of 85 dogs
```
###Description of the data
```{r}
subj.data<- xdata %>% 
  group_by(dog_id) %>% 
  summarise(dog_name=dog_name[1],
            sex=sex[1],
            breed=breed[1], 
            age=age[1],
            counterbalancing_type=counterbalancing_type[1])

table(subj.data$sex)   #number of male and female
table(subj.data$breed) 
summary(subj.data$age)  #age in months
sd(subj.data$age[subj.data$sex == "m"])
sd(subj.data$age[subj.data$sex == "f"])
sum(xdata$session == 1)
sum(xdata$session == 2)
sum(xdata$condition == "looking_away" & xdata$session == 1)
```

###Time between sessions
```{r}
date_data <- xdata %>%
  mutate(test_date = as.Date(test_date, format = "%d/%m/%Y")) %>%
  group_by(dog_name, session) %>%
  summarise(date_session = min(test_date), .groups = "drop") %>% #we keep only one lign per session and per dog
  pivot_wider(names_from = session, values_from = date_session, names_prefix = "session_")  %>% #for each dog we put the date of the sessions in different columns
  mutate(delay = as.numeric(session_2 - session_1))
print(date_data)

mean_delay <- mean(date_data$delay, na.rm = TRUE)
sd_delay <- sd(date_data$delay, na.rm = TRUE)
cat("Mean delay :", round(mean_delay, 2), "days\n")
cat("Standard Deviation delay :", round(sd_delay, 2), "days\n")

#Mean delay : 89.29 days
#Standard Deviation delay : 11.38 days
```

###Significant difference of age between the male and the female ?
```{r}
#check the normality
shapiro.test(subj.data$age[subj.data$sex == "m"])   #p>0,05 : normality ok
shapiro.test(subj.data$age[subj.data$sex == "f"])   #p>0,05 : normality ok
#check the variance homogeneity 
leveneTest(age ~ sex, data = subj.data)  #p>0,05 : variances equal
#We can use the Student test
t.test(age ~ sex, data = subj.data)  #p=0,48 : no significant difference of age between the male and the female
#average age female = 71 months
#average age male = 67 months
```

###Significant difference of age between the 17 different tables ?
```{r}
#We have a maximum of 6 dogs for each counterbalanced type of table so we are going to use global non parametric test
kruskal.test(age ~ counterbalancing_type, data = subj.data) #p=0,459 : no significant difference of age between the 17 different tables

age_summary_table <- subj.data %>%
  group_by(counterbalancing_type) %>%
  summarise(
    n = n(),
    mean_age = round(mean(age, na.rm = TRUE), 1),
    median_age = round(median(age, na.rm = TRUE), 1),
    sd_age = round(sd(age, na.rm = TRUE), 1),
    min_age = min(age, na.rm = TRUE),
    max_age = max(age, na.rm = TRUE))%>%
  arrange(counterbalancing_type)
print(age_summary_table)

```

###Position of the experimenters
```{r}
#Do each experimenter have the same probability to appear at each position (left experimenter, right experimenter or hider) ?

#We pivot the table
data_long <- xdata %>%
  select(dog_id, dog_name, session, experimenter_left_id,
                experimenter_right_id, hider_id) %>%
  distinct(dog_id, session, .keep_all = TRUE) %>%
  pivot_longer(cols = c(experimenter_left_id, experimenter_right_id,
                               hider_id), 
                      names_to = "position", 
                      values_to = "experimenter")

# Number of test (dog × session)
nb_test_uniq <- data_long %>%
  distinct(dog_id, session) %>%
  nrow()

#Participation to the test per experimenter
participation_per_exp <- data_long %>%
  group_by(experimenter, dog_id, session) %>%
  summarise(presence = 1, .groups = "drop") %>% # presence = 1 if experimenter present
  group_by(experimenter) %>%
  summarise(nb_test_participate = n()) %>%
  mutate(pct_participation = 100 * nb_test_participate / nb_test_uniq)

#We are going to do a Chi² test for each experimenter
#We create a list of the experimenter
experimenters <- unique(data_long$experimenter)
#Loop of test
for (exp in experimenters) {
  # Number of time each experimenter occupy each position
  pos_counts <- data_long %>%
    filter(experimenter == exp) %>%
    count(position) %>%
    complete(position = c("experimenter_left_id", "experimenter_right_id", "hider_id"), fill = list(n = 0)) %>%
    arrange(position)
  total_expe_position <- sum(pos_counts$n)
  # Pourcentage
  pos_counts <- pos_counts %>%
    mutate(percentage = round(100 * n / total_expe_position, 1))
  # Global participation of each experimenter
  pct_participation <- participation_per_exp %>%
    filter(experimenter == exp) %>%
    pull(pct_participation)
  # Chi² test
  chi_result <- chisq.test(pos_counts$n, p = rep(1/3, 3))
  # Print the text
  cat("\n====================================\n")
  cat("EXPERIMENTATEUR :", exp, "\n")
  cat("====================================\n")
  cat("Chi² =", round(chi_result$statistic, 3),
      ", df =", chi_result$parameter,
      ", p-value =", round(chi_result$p.value, 4), "\n")
  cat("Distribution positions :\n")
  for (i in 1:nrow(pos_counts)) {
    cat(sprintf("  %-6s : %2d fois (%4.1f%%)\n",
                pos_counts$position[i],
                pos_counts$n[i],
                pos_counts$percentage[i]))}
  cat(sprintf("Participation to all test : %.1f%%\n", pct_participation))}

```

#Preference for the knower
##Individual level 
###Overall all sessions
```{r}
#What are the proportion of preference for the knower in each condition for each dog overall all sessions

#Overall, all conditions
indiv_result_tot_overall <- xdata %>%
  group_by (dog_id) %>%   #we don't take the number of the session into account
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials) %>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value,  #We extract the p-value from the test
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  # We indicate if the preference is above chance level
  select(dog_id, dog_name, choice_knower_tot = knower_pref, trials_tot = trials, ratio_tot = prop_knower_pref, p_value, signif_result_tot_overall = significant)

result_indiv_1_ov <- indiv_result_tot_overall %>% select (dog_id=dog_id,dog_name=dog_name, signif_result_tot_overall = signif_result_tot_overall)

```

```{r}
#Overall, only test condition
indiv_result_test_overall <- xdata %>%
  filter(condition!="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_test = knower_pref, trials_test = trials, ratio_test = prop_knower_pref, p_value, signif_result_test_overall = significant)

result_indiv_2_ov <- indiv_result_test_overall %>% select (signif_result_test_overall = signif_result_test_overall)
#Chilli5, Chilli7, Akira8, NerO3, Bookie, Arany, Finley, Magic4, Jabby, Holly9,  Mickey3
```

```{r}
#Overall, Present condition
indiv_result_present_overall <- xdata %>%
  filter(condition =="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_present = knower_pref, trials_present = trials, ratio_present = prop_knower_pref, p_value, signif_result_present_overall = significant)

result_indiv_3_ov <- indiv_result_present_overall %>% select (signif_result_present_overall = signif_result_present_overall)
#Amor2, Paulinchen, Molly8, Pepper5, Fleeti, Lucy20, Riu, Mickey3
```

```{r}
#Overall, Absent condition
indiv_result_absent_overall <- xdata %>%
  filter(condition =="absent") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_absent = knower_pref, trials_absent = trials, ratio_absent = prop_knower_pref, p_value, signif_result_absent_overall = significant)

result_indiv_4_ov <- indiv_result_absent_overall %>% select (signif_result_absent_overall = signif_result_absent_overall)
#Nero3, Magic4, Jabby, Holly9
```

```{r}
#Overall, Back turned condition
indiv_result_back_turned_overall <- xdata %>%
  filter(condition =="back_turned") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_back_turned = knower_pref, trials_back_turned = trials, ratio_back_turned = prop_knower_pref, p_value, signif_result_back_turned_overall = significant)

result_indiv_5_ov <- indiv_result_back_turned_overall %>% select (signif_result_back_turned_overall = signif_result_back_turned_overall)
#Chilli7, Akira8, Bookie, Finley, Dunni, Woody2
```

```{r}
#Overall, Looking away condition
indiv_result_looking_away_overall <- xdata %>%
  filter(condition =="looking_away") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_looking_away = knower_pref, trials_looking_away = trials, ratio_looking_away = prop_knower_pref, p_value, signif_result_looking_away_overall = significant)

result_indiv_6_ov <- indiv_result_looking_away_overall %>% select (signif_result_looking_away_overall = signif_result_looking_away_overall)
#Silva, Brexit
```

```{r}
#Summary of individual result, overall sessions
result_indiv_overall_session <- bind_cols(result_indiv_1_ov,result_indiv_2_ov,result_indiv_3_ov,result_indiv_4_ov,result_indiv_5_ov,result_indiv_6_ov)
print(result_indiv_overall_session)
```

```{r}
#Plot with ligns following the results of the best dogs
subj.data.cond<- xdata %>% 
  filter (dog_name %in% c("Amor2", "Paulinchen","Molly8", "Pepper5", "Fleeti", "Lucy20", "Riu", "Mickey3", "Magic4", "Nero3", "Jabby", "Holly9", "Chilli7", "Akira8", "Bookie", "Finley", "Dunni", "Woody2", "Brexit", "Silva")) %>% #change the names
  group_by(dog_id, condition) %>% 
  summarise(knower_pref=sum(choice_binary),
            trials=length(choice_binary),
            prop_knower_pref=knower_pref/trials,
            sex=sex[1],
            breed=breed[1],
            age=age[1])

boxplot<-ggplot(data=subj.data.cond %>% 
        mutate(condition=fct_recode(condition, 
                                "Present" = "present", 
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away"),
               condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")), 
       aes(x = condition, y = prop_knower_pref, fill=condition)) +
  geom_boxplot()  +
  geom_jitter(shape=20, position=position_jitter(0.1), alpha=.5)+
  geom_line(aes(group = dog_id, color = dog_id), alpha = 0.5, linewidth = 1) +
  ylim(c(0,1))+
  ylab("Proportion of preference fot the knower")+
  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14))
boxplot

```

###For the 1st session
```{r}
#What are the proportion of preference for the knower in each condition for each dog in the 1st session

#First session, all conditions
indiv_result_tot_1st <- xdata %>%
  filter(session==1) %>% #we only take the results from the 1st session
  group_by (dog_id) %>%   
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials) %>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value,  #We extract the p-value from the test
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  # We indicate if the preference is above chance level
  select(dog_id, dog_name, choice_knower_tot = knower_pref, trials_tot = trials, ratio_tot = prop_knower_pref, p_value, signif_result_tot_1st = significant)

#Yes for Ganesh (p=0,01 ; 18/24), Nero3 (p=0,03 ; 17/24), Bookie (p=0,01 ; 18/24), Finley (p=0,03 ; 17/24), Jabby (p=0,03 ; 17/24), Preemo (p=0,01 ; 18/24) ; Zita2 (p=0,02 ; 17/23) ; Mickey3 (p=0,0008 ; 20/24)

result_indiv_1_1st <- indiv_result_tot_1st %>% select (dog_id=dog_id,dog_name=dog_name, signif_result_tot_1st = signif_result_tot_1st)
```

```{r}
#First session, only test condition
indiv_result_test_1st <- xdata %>%
  filter(session==1) %>%
  filter(condition!="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_test = knower_pref, trials_test = trials, ratio_test = prop_knower_pref, p_value, signif_result_test_1st = significant)

#Yes for Ganesh (p=0,048 ; 13/18), Nero3 (p=0,048 ; 13/18) ; Bookie (p=0,04 ; 15/18), Finley (p=0,048 ; 13/18), Jabby (p=0,04 ; 15/18), Preemo (p=0,048 ; 13/18) ; Zita2 (p=0,02 ; 13/17) ; Mickey3 (p=0,01 ; 14/18)

result_indiv_2_1st <- indiv_result_test_1st %>% select (signif_result_test_1st = signif_result_test_1st)
```

```{r}
#First session, Present condition
indiv_result_present_1st <- xdata %>%
  filter(session==1) %>%
  filter(condition =="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_present = knower_pref, trials_present = trials, ratio_present = prop_knower_pref, p_value, signif_result_present_1st = significant)

#Yes for Mickey3 (p=0,01 ; 6/6)

result_indiv_3_1st <- indiv_result_present_1st %>% select (signif_result_present_1st = signif_result_present_1st)
```

```{r}
#First session, Absent condition
indiv_result_absent_1st <- xdata %>%
  filter(session==1) %>%
  filter(condition =="absent") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_absent = knower_pref, trials_absent = trials, ratio_absent = prop_knower_pref, p_value, signif_result_absent_1st = significant)

#Yes for Nero3 (p=0,01 ; 6/6), Jabby (p=0,01 ; 6/6), Preemo (p=0,01 ; 6/6)

result_indiv_4_1st <- indiv_result_absent_1st %>% select (signif_result_absent_1st = signif_result_absent_1st)
```

```{r}
#First session, Back turned condition
indiv_result_back_turned_1st <- xdata %>%
  filter(session==1) %>%
  filter(condition =="back_turned") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_back_turned = knower_pref, trials_back_turned = trials, ratio_back_turned = prop_knower_pref, p_value, signif_result_back_turned_1st = significant)

#Yes for Bookie (p=0,01 ; 6/6), Nero4 (p=0,01 ; 6/6), Woody2 (p=0,01 ; 6/6), 

result_indiv_5_1st <- indiv_result_back_turned_1st %>% select (signif_result_back_turned_1st = signif_result_back_turned_1st)
```

```{r}
#First session, Looking away condition
indiv_result_looking_away_1st <- xdata %>%
  filter(session==1) %>%
  filter(condition =="looking_away") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_looking_away = knower_pref, trials_looking_away = trials, ratio_looking_away = prop_knower_pref, p_value, signif_result_looking_away_1st = significant)

#Yes for no one

result_indiv_6_1st <- indiv_result_looking_away_1st %>% select (signif_result_looking_away_1st = signif_result_looking_away_1st)
```

```{r}
#Summary of individual results in the first session
result_indiv_1st_session <- bind_cols(result_indiv_1_1st,result_indiv_2_1st,result_indiv_3_1st,result_indiv_4_1st,result_indiv_5_1st,result_indiv_6_1st)
print(result_indiv_1st_session)

#No impact of the age, the sex and the breed : 
#Jabby (romagna_waterdog, f, 67 months) 
#Nero3 (belgian_shepherd_dog_malinois, m, 18 months) 
#Nero4 (staffordshire_bull_terrier, m, 44 months)
#Bookie (maltese, 50 months)
#Woody2 (irish_red_and_white_setter, m, 129 months)
#Ganesh (mix, m, 90 months)
#Preemo (romagna_waterdog, m, 51 months)
#Finley (shetland_sheepdog_sheltie, m, 91 months)
#Mickey3 (beagle, m, 121 months)
#Zita2 (belgian_shepherd_dog_malinois,f,117 months)
```

###For the 2nd session
```{r}
#What are the proportion of preference for the knower in each condition for each dog in the 2nd session

#Second session, all conditions
indiv_result_tot_2nd <- xdata %>%
  filter(session==2) %>% #we only take the results from the 2nd session
  group_by (dog_id) %>%   
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials) %>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value,  #We extract the p-value from the test
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  # We indicate if the preference is above chance level
  select(dog_id, dog_name, choice_knower_tot = knower_pref, trials_tot = trials, ratio_tot = prop_knower_pref, p_value, signif_result_tot_2nd = significant)

result_indiv_1_2nd <- indiv_result_tot_2nd %>% select (dog_id=dog_id,dog_name=dog_name, signif_result_tot_2nd = signif_result_tot_2nd)
```

```{r}
#Second session, only test condition
indiv_result_test_2nd <- xdata %>%
  filter(session==2) %>%
  filter(condition!="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_test = knower_pref, trials_test = trials, ratio_test = prop_knower_pref, p_value, signif_result_test_2nd = significant)

result_indiv_2_2nd <- indiv_result_test_2nd %>% select (signif_result_test_2nd = signif_result_test_2nd)
#Chilli7, Akira8, Bookie, Arany, Asha, Magic4, Holly9, Riu
```

```{r}
#Second session, Present condition
indiv_result_present_2nd <- xdata %>%
  filter(session==2) %>%
  filter(condition =="present") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_present = knower_pref, trials_present = trials, ratio_present = prop_knower_pref, p_value, signif_result_present_2nd = significant)

result_indiv_3_2nd <- indiv_result_present_2nd %>% select (signif_result_present_2nd = signif_result_present_2nd)
#Azzuro, Paulinchen, Mooly8, Fleeti, Lucy20, Riu
```

```{r}
#Second session, Absent condition
indiv_result_absent_2nd <- xdata %>%
  filter(session==2) %>%
  filter(condition =="absent") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_absent = knower_pref, trials_absent = trials, ratio_absent = prop_knower_pref, p_value, signif_result_absent_2nd = significant)

result_indiv_4_2nd <- indiv_result_absent_2nd %>% select (signif_result_absent_2nd = signif_result_absent_2nd)
#Bo, Arany, Magic4,Holly9, Riu
```

```{r}
#Second session, Back turned condition
indiv_result_back_turned_2nd <- xdata %>%
  filter(session==2) %>%
  filter(condition =="back_turned") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_back_turned = knower_pref, trials_back_turned = trials, ratio_back_turned = prop_knower_pref, p_value, signif_result_back_turned_2nd = significant)

result_indiv_5_2nd <- indiv_result_back_turned_2nd %>% select (signif_result_back_turned_2nd = signif_result_back_turned_2nd)
#Akira8, Poppy4
```

```{r}
#Second session, Looking away condition
indiv_result_looking_away_2nd <- xdata %>%
  filter(session==2) %>%
  filter(condition =="looking_away") %>%
  group_by (dog_id) %>%
  summarise(
    dog_name = dog_name[1],
    knower_pref=sum(choice_binary),
    trials=length(choice_binary),
    prop_knower_pref=knower_pref/trials)%>%
  rowwise() %>% 
  mutate(binom_test = list(binom.test(knower_pref, trials, p = 0.5, alternative = "greater")),
    p_value = binom_test$p.value, 
    significant = ifelse(p_value < 0.05, "Yes", "No")) %>%  
  select(dog_id, dog_name, choice_knower_looking_away = knower_pref, trials_looking_away = trials, ratio_looking_away = prop_knower_pref, p_value, signif_result_looking_away_2nd = significant)

result_indiv_6_2nd <- indiv_result_looking_away_2nd %>% select (signif_result_looking_away_2nd = signif_result_looking_away_2nd)
#no dog
```

```{r}
#Summary of individual results in the second session
result_indiv_2nd_session <- bind_cols(result_indiv_1_2nd,result_indiv_2_2nd,result_indiv_3_2nd,result_indiv_4_2nd,result_indiv_5_2nd,result_indiv_6_2nd)
print(result_indiv_2nd_session)
```

###Try graph with everything 
```{r}
#Needs to run df_all in
##Group level
###Plot with result of each session + both
selected_dogs <- c("Paulinchen","Riu", "Fleeti", "Pepper5","Amor2", "Nero3", "Jabby", "Woody2", "Dunni", "Finley", "Akira8", "Chilli7", "Brexit", "Silva", "Nero4", "Azzuro", "Arany", "Bo", "Poppy4", "Bookie", "Chilli5", "Magic4","Holly9","Mickey3", "Molly8","Lucy20","Preemo","Asha")  

# 1. Prepare df_all with cond_sess 
df_all <- df_all %>%
  mutate(
    y_pos_session = -0.05,
    cond_sess = paste(condition, session, sep = "_"),
    cond_sess = factor(cond_sess,
                       levels = c(
                         "Present_S1", "Present_S2", "Present_Both",
                         "Absent_S1", "Absent_S2", "Absent_Both",
                         "Back turned_S1", "Back turned_S2", "Back turned_Both",
                         "Looking away_S1", "Looking away_S2", "Looking away_Both")),
    session = factor(session, levels = c("S1", "S2", "Both")),
    condition = factor(condition, levels = c("Present", "Absent", "Back turned", "Looking away")),
    x_order = as.numeric(condition) + (as.numeric(session) - 1) * length(levels(condition)))

# 2. Prepared data for each dogs
# Per session
highlight_dogs_session <- xdata %>%
  filter(dog_name %in% selected_dogs) %>%
  group_by(dog_name, session, condition) %>%
  summarise(prop_choice = mean(choice_binary, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    condition = fct_recode(condition, 
                           "Present" = "present", 
                           "Absent" = "absent",
                           "Back turned" = "back_turned", 
                           "Looking away" = "looking_away"),
    condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away"),
    session = recode(as.character(session), "1" = "S1", "2" = "S2"),
    session = factor(session, levels = c("S1", "S2")))

# For both session
highlight_dogs_both <- xdata %>%
  filter(dog_name %in% selected_dogs) %>%
  group_by(dog_name, condition) %>%
  summarise(prop_choice = mean(choice_binary, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    session = "Both",
    condition = fct_recode(condition, 
                           "Present" = "present", 
                           "Absent" = "absent",
                           "Back turned" = "back_turned", 
                           "Looking away" = "looking_away"),
    condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away"),
    session = factor(session, levels = c("S1", "S2", "Both")))

# Fusion
highlight_dogs_all <- bind_rows(highlight_dogs_session, highlight_dogs_both)

# Now use levels defined before
levels_cond_sess <- levels(df_all$cond_sess)

highlight_dogs_all <- highlight_dogs_all %>%
  mutate(
    session = factor(session, levels = c("S1", "S2", "Both")),
    condition = factor(condition, levels = c("Present", "Absent", "Back turned", "Looking away")))

# 3. Prepare data of significance
sig_dog_S1 <- result_indiv_1st_session %>%
  filter(dog_name %in% selected_dogs) %>%
  rename(
    Present = `signif_result_present_1st`,    
    Absent = `signif_result_absent_1st`,
    `Back turned` = `signif_result_back_turned_1st`,
    `Looking away` = `signif_result_looking_away_1st`)%>%
  pivot_longer(
    cols = c("Present", "Absent", "Back turned", "Looking away"),
    names_to = "condition",
    values_to = "significant") %>%
  mutate(significant = significant == "Yes",session = "S1")

sig_dog_S2 <- result_indiv_2nd_session %>%
  filter(dog_name %in% selected_dogs) %>%
   rename(
    Present = `signif_result_present_2nd`,    
    Absent = `signif_result_absent_2nd`,
    `Back turned` = `signif_result_back_turned_2nd`,
    `Looking away` = `signif_result_looking_away_2nd`)%>%
  pivot_longer(
    cols = c("Present", "Absent", "Back turned", "Looking away"),
    names_to = "condition",
    values_to = "significant") %>%
  mutate(significant = significant == "Yes",session = "S2")

sig_dog_both <- result_indiv_overall_session %>%
  filter(dog_name %in% selected_dogs) %>%
   rename(
    Present = `signif_result_present_overall`,    
    Absent = `signif_result_absent_overall`,
    `Back turned` = `signif_result_back_turned_overall`,
    `Looking away` = `signif_result_looking_away_overall`)%>%
  pivot_longer(
    cols = c("Present", "Absent", "Back turned", "Looking away"),
    names_to = "condition",
    values_to = "significant") %>%
  mutate(significant = significant == "Yes",session = "Both")

sig_all <- bind_rows(sig_dog_S1, sig_dog_S2, sig_dog_both)

highlight_dogs_all <- highlight_dogs_all %>%
  left_join(sig_all, by = c("dog_name", "condition", "session"))
highlight_dogs_all <- highlight_dogs_all %>%
  mutate(dog_name = factor(dog_name, levels = selected_dogs)) %>%
  mutate(cond_sess = paste(condition, session, sep = "_"),
         cond_sess = factor(cond_sess,
                            levels = levels(df_all$cond_sess)))
highlight_dogs_all <- highlight_dogs_all %>%
  mutate(
    cond_sess = factor(cond_sess, levels = levels(df_all$cond_sess)),
    dog_name = factor(dog_name, levels = selected_dogs))

#Dogs' label
dog_info <- xdata %>%
  filter(dog_name %in% selected_dogs) %>%
  mutate(breed = ifelse(dog_name == "Azzuro", "hungarian_viszla", breed))%>%
  mutate(breed = ifelse(dog_name == "Akira8", "old_german_shepherd", breed))%>%
  mutate(breed = ifelse(dog_name == "Silva", "old_german_shepherd", breed))%>%
  mutate(breed = ifelse(dog_name == "Molly8", "old_german_shepherd", breed))%>%
  mutate(breed = ifelse(dog_name == "Finley", "shetland_sheepdog", breed))%>%
  mutate(breed = ifelse(dog_name == "Nero3", "belgian_malinois", breed))%>%
  mutate(breed = ifelse(dog_name == "Woody2", "irish_setter", breed))%>%
  arrange(dog_name, session) %>%
  group_by(dog_name) %>%
  slice(1) %>%
  ungroup() %>%
  select(dog_name, age, breed)

highlight_dogs_all <- highlight_dogs_all %>%
  select(-any_of(c("breed", "age"))) %>% 
  left_join(dog_info, by = "dog_name") %>%
  mutate(
    breed = str_replace_all(breed, "_", " "),
    dog_label = paste0(dog_name, " : ", age, " m, ", breed))

##Forcing alignment
# 1. Create x_num for each bar
levels_order <- levels(df_all$cond_sess)
highlight_dogs_all <- highlight_dogs_all %>%
  mutate(x_num = as.numeric(factor(cond_sess, levels = levels_order)))

# 2. Horizontal gap depending on the rank of the dog
n_dogs <- length(selected_dogs)
width_total <- 0.4  # gap between points 
step <- width_total / (n_dogs + 1)

highlight_dogs_all <- highlight_dogs_all %>%
  mutate(
    dog_rank = as.integer(factor(dog_name, levels = selected_dogs)),
    x_plot = x_num - width_total/2 + dog_rank * step  )


# 4. Colors and label
my_colors <- c(
  "Present_S1" = "darkolivegreen1",
  "Absent_S1" = "lightblue",
  "Back turned_S1" = "lightsalmon",
  "Looking away_S1" = "plum2",
  "Present_S2" = "darkolivegreen3",
  "Absent_S2" = "cadetblue3",
  "Back turned_S2" = "coral1",
  "Looking away_S2" = "orchid3",
  "Present_Both" = "darkolivegreen",
  "Absent_Both" = "deepskyblue4",
  "Back turned_Both" = "brown3",
  "Looking away_Both" = "mediumorchid4")

df_all$color <- my_colors[as.character(df_all$cond_sess)]

condition_labels <- df_all %>%
  group_by(condition) %>%
  summarise(x = mean(as.numeric(cond_sess))) %>%
  mutate(y = -0.1)

# Define position dodge with a group (dog_name) 
pos_dodge <- position_dodge2(width = 0.8, preserve = "single")

plot_indiv <-ggplot(df_all, aes(x = cond_sess, y = prop_choice, fill = color)) +
  geom_bar(stat = "identity", position = pos_dodge) +
  scale_fill_identity() +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                position = pos_dodge,
                width = 0.2) +
  geom_point(data = highlight_dogs_all,
           aes(x = x_plot, y = prop_choice, color = dog_label),
           size = 2, alpha = 0.8, inherit.aes = FALSE,show.legend = FALSE) +
  geom_line(data = highlight_dogs_all,
          aes(x = x_plot, y = prop_choice, color = dog_label, group = dog_label),
          size = 0.2, alpha = 0.6, inherit.aes = FALSE, show.legend = FALSE) +
  geom_text(data = highlight_dogs_all %>% filter(significant == TRUE),
          aes(x = x_plot, y = prop_choice + 0.05, label = "*", color = dog_label),
          size = 6, inherit.aes = FALSE, show.legend = FALSE)+
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  geom_text(aes(label = session, y = y_pos_session),
            position = pos_dodge,
            size = 3, color = "black") +
  geom_text(data = condition_labels,
            aes(x = x, y = y, label = condition),
            inherit.aes = FALSE,
            size = 4, fontface = "bold") +
  scale_x_discrete(labels = function(x) gsub("_", "\n", x)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(-0.15, 1.1)) +
  labs(x = NULL, y = "Percentage of choice for the Knower", color = "Dog (age, breed)") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        legend.key.size = unit(0.9, "cm"),
        legend.text = element_text(size = 14),
        legend.spacing.y = unit(1, "cm"),
        legend.margin = margin(0.1,0.1, 0.1, 0.1))
      
```

print(plot_indiv)

##Group level
###Overall all sessions
```{r}
#We are going to do intercept only binomial models (iobm)

#Overall sessions, only test conditions
test.data.overall<-xdata %>% 
  filter(condition!="present") #we remove the control condition
# Run the model
iobm.overall.test=glmer(choice_binary ~ 1 + (1|dog_id), 
      #~1 is the intercept, compares to the average of success overall dogs 
      #no predictive variable, dog_id is set as a random variable, it means that each dogs can have a different number of success and we have multiple observations for eahc dog
             data=test.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
      #"bobyqa" = optimizer, which is generally more robust and efficient
      #optCtrl = increases the maximum number of function evaluations to 200,000 usefull if convergence is slow.

confint_iobm.overall.test <- confint(iobm.overall.test, method = "Wald") #confidence intervalle
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit)) #fonction to go from OR to proba
prob_intercept <- logit_to_prob(fixef(iobm.overall.test)[1]) #estimated probability
confint_prob <- logit_to_prob(confint_iobm.overall.test["(Intercept)", ]) #intervalle of probability

cat("Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.54
#95% Confidence intervalle of probability:  0.522 - 0.559 

summary(iobm.overall.test)
#p-value = 2.44e-05
#z-value = 4.22
#std error = 0.03839
```

```{r}
#Overall sessions, Present condition
present.data.overall<-xdata %>% 
  filter(condition=="present") 
iobm.overall.present=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=present.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.present <- confint(iobm.overall.present, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.present)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.present["(Intercept)", ]) 

cat("Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.573 
#95% Confidence intervalle of probability:0.542 - 0.604 

summary(iobm.overall.present)
#p-value = 4.77e-06
#z-value = 4.575
#std error =  0.06453
```

```{r}
#Overall sessions, Absent condition
absent.data.overall<-xdata %>% 
  filter(condition=="absent") 
iobm.overall.absent=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=absent.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.absent <- confint(iobm.overall.absent, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.absent)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.absent["(Intercept)", ]) 

cat("Absent Estimated probability:", round(prob_intercept, 3), "\n",
    "Absent 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.524 
#95% Confidence intervalle of probability:  0.49 - 0.559 

summary(iobm.overall.absent)
#p-value =  0.17
#z-value = 1.372
#std error =  0.07108
```

```{r}
#Overall sessions, Back turned condition
back.turned.data.overall<-xdata %>% 
  filter(condition=="back_turned") 
iobm.overall.back.turned=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=back.turned.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.back.turned <- confint(iobm.overall.back.turned, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.back.turned)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.back.turned["(Intercept)", ]) 

cat("Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: : 0.597
#95% Confidence intervalle of probability:  0.566 - 0.628 

summary(iobm.overall.back.turned)
#p-value = 2.56e-09
#z-value = 5.958
#std error = 0.06622 
```

```{r}
#Overall sessions, Looking away condition
looking.away.data.overall<-xdata %>% 
  filter(condition=="looking_away") 
iobm.overall.looking.away=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=looking.away.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.looking.away <- confint(iobm.overall.looking.away, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.looking.away)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.looking.away["(Intercept)", ]) 

cat("Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability:  0.509 
#95% Confidence intervalle of probability: 0.478 - 0.54 

summary(iobm.overall.looking.away)
#p-value =  0.569
#z-value = 0.57 
#std error =   0.06332
```

```{r}
#Overall sessions, plot for with all conditions
data.plot.overall <- xdata %>%
  group_by(dog_id, condition) %>% 
  summarise(knower_pref=sum(choice_binary),
            trials=length(choice_binary),
            prop_knower_pref=knower_pref/trials) %>% 
  mutate(condition=fct_recode(condition, "Present" = "present",
                   "Absent" = "absent","Back turned" = "back_turned",
                   "Looking away" = "looking_away"),
                condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")) %>% #put the condition in order
  group_by(condition) %>% 
  summarise(total_trials = sum(trials, na.rm = TRUE),
    avg_knower_pref=mean(prop_knower_pref, na.rm=T),
    se = sd(prop_knower_pref, na.rm = TRUE) / sqrt(n()),  # Standard Error
    ci_lower = avg_knower_pref - qt(0.975, df = n() - 1) * se,  # Lower 95% CI
    ci_upper = avg_knower_pref + qt(0.975, df = n() - 1) * se)   # Upper 95% CI

bar_plot_overall<-ggplot(data=data.plot.overall,
  aes(x=condition, y= avg_knower_pref, fill=condition)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +  #Error bars at 95% CI
  geom_text(aes(x = 1, y = 0.69, label = "*"), size = 8) +  #p<0,05
  geom_text(aes(x = 3, y = 0.69, label = "*"), size = 8) +
  geom_hline(yintercept = 0.5, lty=2) +
  coord_cartesian(ylim = c(0.2, 0.7))+
  ylab("Average preference for the knower")+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )

bar_plot_overall
```

###Boxplot overal session for each condition
```{r}
#Adapted from Sarah Verrart coding
# Nb of times each dog chose the Knower per condition (sum of choice_binary)
K_choice_count <- aggregate(choice_binary ~ dog_id + condition, data = xdata, FUN = sum, na.rm = TRUE)

# Nb of trials per condition per dog (because of some NA it is not always 6 trials per condition per dog)
trial_per_cond_count <- aggregate(choice_binary ~ dog_id + condition, data = xdata, FUN = function(x) sum(!is.na(x)))

# Merge the two 
data_K_choice_prop <- merge(K_choice_count, trial_per_cond_count, by = c("dog_id", "condition"), suffixes = c("_K_chosen", "_total"))

#proportion
data_K_choice_prop$proportion_K <- data_K_choice_prop$choice_binary_K_chosen / data_K_choice_prop$choice_binary_total

#the percentiles
data_boxplot <- data_K_choice_prop %>%
  group_by(condition) %>%
  summarise(
    ymin = quantile(proportion_K, 0.10, na.rm = TRUE),
    lower = quantile(proportion_K, 0.25, na.rm = TRUE),
    middle = median(proportion_K, na.rm = TRUE),
    upper = quantile(proportion_K, 0.75, na.rm = TRUE),
    ymax = quantile(proportion_K, 0.90, na.rm = TRUE),
    outliers = list(proportion_K[proportion_K < ymin | proportion_K > ymax])) %>%
  ungroup() %>%
  mutate(condition = factor(condition, levels = c("present", "absent", "back_turned", "looking_away")))

#the outliers
outliers_df <- data_boxplot %>%
  tidyr::unnest(cols = c(outliers)) %>%
  rename(outlier = outliers)

boxplot_overall <- ggplot(data_boxplot, aes(x = condition)) +
  geom_boxplot(aes(ymin = ymin,
      lower = lower,
      middle = middle,
      upper = upper,
      ymax = ymax,
      fill = condition),stat = "identity", color = "black",outlier.shape = NA) +
  geom_point(data = outliers_df, aes(x = condition, y = outlier), color = "black", size =1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("absent" = "cadetblue3",
      "present" = "darkolivegreen1",
      "back_turned" = "lightsalmon",
      "looking_away" = "plum2"),
      labels = c(
      "present" = "Present",
      "absent" = "Absent",
      "back_turned" = "Back Turned",
      "looking_away" = "Looking Away"))+
      scale_x_discrete(labels = c(
    "present" = "Present",
    "absent" = "Absent",
    "back_turned" = "Back Turned",
    "looking_away" = "Looking Away")) +
  labs(x = NULL,y = "Percentage of choice for the Knower") +
  guides(fill = FALSE) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 14))

```

print(boxplot_overall)

### Plot comparison with (Catala et al., 2017)
```{r}
#We Will create a plot to compare our results overall all sessions to (Catala et al., 2017)

#We create a table with our data and the one from (Catala et al., 2017)
data.plot.vs.catala <- data.plot.overall
data.plot.vs.catala$studies <- factor(c("us","us","us","us"))
data.plot.vs.catala$bar_color <-c("#F8766D","#7CAE00","#00BFC4","#C77CFF" )

present_catala <- data.frame(
      condition = "Present", avg_knower_pref = 0.5637,se = NA,
      ci_lower = 0.495,ci_upper = 0.629,
      studies = "catala",bar_color="#9C3E36",
      total_trials = 374)
absent_catala <- data.frame(
      condition = "Absent", avg_knower_pref = 0.72375, se = NA,
      ci_lower = 0.659, ci_upper = 0.787, 
      studies = "catala", bar_color="#366100",
      total_trials = 372)
back_turned_catala <-data.frame(
      condition = "Back turned", avg_knower_pref = NA, se = NA,
      ci_lower = NA, ci_upper = NA,
      studies = "catala", bar_color="#00BFC4",
      total_trials = 0)
looking_away_catala <- data.frame(
      condition = "Looking away", avg_knower_pref = 0.6175, se = NA,
      ci_lower = 0.565, ci_upper = 0.669, 
      studies = "catala", bar_color="#4D236D",
      total_trials = 382)

data.plot.vs.catala <- bind_rows(looking_away_catala,data.plot.vs.catala)
data.plot.vs.catala <- bind_rows(back_turned_catala,data.plot.vs.catala)
data.plot.vs.catala <- bind_rows(absent_catala,data.plot.vs.catala)
data.plot.vs.catala <- bind_rows(present_catala,data.plot.vs.catala)

data.plot.vs.catala$studies <- factor(data.plot.vs.catala$studies, levels = c("us", "catala")) #we put "us" and "catala" as factor
data.plot.vs.catala$condition <- factor(data.plot.vs.catala$condition, 
                levels = c("Present", "Absent", "Back turned", "Looking away")) 
#we put the conditions name as factor
data.plot.vs.catala$bar_id <-as.character(interaction(data.plot.vs.catala$condition, data.plot.vs.catala$studies))
#We create a new variable giving the identity of each bar of our plot
print (data.plot.vs.catala)


bar_plot_vs_catala <- ggplot(data = data.plot.vs.catala, 
  aes(x = condition, y = avg_knower_pref, fill = bar_id, group =studies)) + 
  geom_bar(stat = "identity", position = position_dodge(width =0.9)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                width = 0.2, 
                position = position_dodge(width = 0.9)) +
  geom_text(aes(x = 0.78, y = 0.63, label = "*"), size = 8) +
  geom_text(aes(x = 2.23, y = 0.8, label = "*"), size = 8) +
  geom_text(aes(x = 2.77, y = 0.66, label = "*"), size = 8) +
  geom_text(aes(x = 4.23, y = 0.7, label = "*"), size = 8) +
  geom_text(aes(x = condition, y = 0.2, label = paste0("n=", total_trials)),
            position = position_dodge(width = 0.9),
            color = "black",size = 4)+
  geom_hline(yintercept = 0.5, lty = 2) +
  coord_cartesian(ylim = c(0.2, 0.8)) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +  
  ylab("Percentage of choice for the Knower") +  
  scale_fill_manual( values = setNames(data.plot.vs.catala$bar_color, data.plot.vs.catala$bar_id))+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )
```

print(bar_plot_vs_catala)

###First session
```{r}
#We are going to do intercept only binomial models (iobm)
#First session, only test conditions
test.data.1st<-xdata %>% 
  filter(condition!="present")%>% 
  filter (session ==1) 
iobm.1st.test=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=test.data.1st, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.1st.test <- confint(iobm.1st.test, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit)) 
prob_intercept <- logit_to_prob(fixef(iobm.1st.test)[1]) 
confint_prob <- logit_to_prob(confint_iobm.1st.test["(Intercept)", ]) 

cat("Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.532
#95% Confidence intervalle of probability: 0.508 - 0.555 

summary(iobm.1st.test)
#p-value = 0.00919 
#z-value =  2.605
#std error = 0.04882
```

```{r}
#First session, Present condition
present.data.1st<-xdata %>% 
  filter(condition=="present") %>% 
  filter (session ==1) 
iobm.1st.present=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=present.data.1st, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.1st.present <- confint(iobm.1st.present, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.1st.present)[1])
confint_prob <- logit_to_prob(confint_iobm.1st.present["(Intercept)", ]) 

cat("Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0,558
#95% Confidence intervalle of probability: 0.516 - 0.598 

summary(iobm.1st.present)
#p-value = 0.00627
#z-value = 2.733
#std error = 0.08486
```

```{r}
#First session, Absent condition
absent.data.1st<-xdata %>% 
  filter(condition=="absent") %>% 
  filter (session ==1) 
iobm.1st.absent=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=absent.data.1st, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.1st.absent <- confint(iobm.1st.absent, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.1st.absent)[1])
confint_prob <- logit_to_prob(confint_iobm.1st.absent["(Intercept)", ]) 

cat("Absent Estimated probability:", round(prob_intercept, 3), "\n",
    "Absent 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.484
#95% Confidence intervalle of probability: 0.443 - 0.525  

summary(iobm.1st.absent)
#p-value = 0.448
#z-value = -0.759
#std error = 0.08441
```

```{r}
#First session, Back turned condition
back.turned.data.1st<-xdata %>% 
  filter(condition=="back_turned") %>% 
  filter (session ==1)  
iobm.1st.back.turned=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=back.turned.data.1st, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.1st.back.turned <- confint(iobm.1st.back.turned, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.1st.back.turned)[1])
confint_prob <- logit_to_prob(confint_iobm.1st.back.turned["(Intercept)", ]) 

cat("Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.605
#95% Confidence intervalle of probability: 0.564 - 0.645   

summary(iobm.1st.back.turned)
#p-value = 7.81e-07
#z-value = 4.94
#std error = 0.08629
```

```{r}
#First session, Looking away condition
looking.away.data.1st<-xdata %>% 
  filter(condition=="looking_away") %>% 
  filter (session ==1) 
iobm.1st.looking.away=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=looking.away.data.1st, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.1st.looking.away <- confint(iobm.1st.looking.away, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.1st.looking.away)[1])
confint_prob <- logit_to_prob(confint_iobm.1st.looking.away["(Intercept)", ]) 

cat("Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.506
#95% Confidence intervalle of probability: 0.465 - 0.547   

summary(iobm.1st.looking.away)
#p-value = 0.768
#z-value = 0.296
#std error = 0.08445
```

```{r}
#First session, plot for with all conditions
data.plot.1st <- xdata %>%
  filter(session==1) %>%
  group_by(dog_id, condition) %>% 
  summarise(knower_pref=sum(choice_binary),
            trials=length(choice_binary),
            prop_knower_pref=knower_pref/trials) %>% 
  mutate(condition=fct_recode(condition, 
                              "Present" = "present",
                              "Absent" = "absent",
                              "Back turned" = "back_turned",
                              "Looking away" = "looking_away"),
         condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")) %>% #put the condition in order
  group_by(condition) %>% 
  summarise(avg_knower_pref=mean(prop_knower_pref, na.rm=T),
            se = sd(prop_knower_pref, na.rm = TRUE) / sqrt(n()),  # Standard Error
    ci_lower = avg_knower_pref - qt(0.975, df = n() - 1) * se,  # Lower 95% CI
    ci_upper = avg_knower_pref + qt(0.975, df = n() - 1) * se,
    n_trials = sum(trials))   # Upper 95% CI

bar_plot_1st<-ggplot(data=data.plot.1st,
  aes(x=condition, y= avg_knower_pref, fill=condition)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +  #Error bars at 95% CI
  geom_text(aes(x = 1, y = 0.69, label = "*"), size = 8) +  #p<0,05
  geom_text(aes(x = 3, y = 0.69, label = "*"), size = 8) +
  geom_hline(yintercept = 0.5, lty=2) +
  coord_cartesian(ylim = c(0.2, 0.7))+
  ylab("Average preference for the knower")+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )

bar_plot_1st
```

###Second session
```{r}
#We are going to do intercept only binomial models (iobm)

#Second session, only test conditions
test.data.2nd<-xdata %>% 
  filter(condition!="present") %>% 
  filter (session ==2)
iobm.2nd.test=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=test.data.2nd, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.2nd.test <- confint(iobm.2nd.test, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.2nd.test)[1])
confint_prob <- logit_to_prob(confint_iobm.2nd.test["(Intercept)", ])

cat("Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.549 
#95% Confidence intervalle of probability:  0.524 - 0.573 

summary(iobm.2nd.test)
#p-value =0.000113 
#z-value =  3.861 
#std error = 0.0508 
```

```{r}
#Second session, Present condition
present.data.2nd<-xdata %>% 
  filter(condition=="present") %>% 
  filter (session ==2)
iobm.2nd.present=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=present.data.2nd, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.2nd.present <- confint(iobm.2nd.present, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.2nd.present)[1])
confint_prob <- logit_to_prob(confint_iobm.2nd.present["(Intercept)", ]) 

cat("Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.588 
#95% Confidence intervalle of probability: 0.545 - 0.63 

summary(iobm.2nd.present)
#p-value = 7.27e-05
#z-value = 3.967
#std error =  0.08993
```

```{r}
#Second session, Absent condition
absent.data.2nd<-xdata %>% 
  filter(condition=="absent") %>% 
  filter (session ==2)
iobm.2nd.absent=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=absent.data.2nd, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.2nd.absent <- confint(iobm.2nd.absent, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.2nd.absent)[1])
confint_prob <- logit_to_prob(confint_iobm.2nd.absent["(Intercept)", ]) 

cat("Absent Estimated probability:", round(prob_intercept, 3), "\n",
    "Absent 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.568 
#95% Confidence intervalle of probability:  0.523 - 0.611 

summary(iobm.2nd.absent)
#p-value =  0.00289 
#z-value = 2.979
#std error =  0.09142
```

```{r}
#Second session, Back turned condition
back.turned.data.2nd<-xdata %>% 
  filter(condition=="back_turned") %>% 
  filter (session ==2)
iobm.2nd.back.turned=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=back.turned.data.2nd, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.2nd.back.turned <- confint(iobm.2nd.back.turned, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.2nd.back.turned)[1])
confint_prob <- logit_to_prob(confint_iobm.2nd.back.turned["(Intercept)", ]) 

cat("Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.584 
#95% Confidence intervalle of probability:  0.541 - 0.626 

summary(iobm.2nd.back.turned)
#p-value =  0.000127
#z-value = 3.833
#std error =  0.08881
```

```{r}
#Second session, Looking away condition
looking.away.data.2nd<-xdata %>% 
  filter(condition=="looking_away") %>% 
  filter (session ==2)
iobm.2nd.looking.away=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=looking.away.data.2nd, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.2nd.looking.away <- confint(iobm.2nd.looking.away, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.2nd.looking.away)[1])
confint_prob <- logit_to_prob(confint_iobm.2nd.looking.away["(Intercept)", ]) 

cat("Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.495 
#95% Confidence intervalle of probability:  0.452 - 0.538   

summary(iobm.2nd.looking.away)
#p-value = 0.827
#z-value =  -0.219
#std error =  0.08763
```

```{r}
#First session, plot for with all conditions
data.plot.2nd <- xdata %>%
  filter(session==2) %>%
  group_by(dog_id, condition) %>% 
  summarise(knower_pref=sum(choice_binary),
            trials=length(choice_binary),
            prop_knower_pref=knower_pref/trials) %>% 
  mutate(condition=fct_recode(condition, 
                              "Present" = "present",
                              "Absent" = "absent",
                              "Back turned" = "back_turned",
                              "Looking away" = "looking_away"),
         condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")) %>% #put the condition in order
  group_by(condition) %>% 
  summarise(avg_knower_pref=mean(prop_knower_pref, na.rm=T),
            se = sd(prop_knower_pref, na.rm = TRUE) / sqrt(n()),  # Standard Error
    ci_lower = avg_knower_pref - qt(0.975, df = n() - 1) * se,  # Lower 95% CI
    ci_upper = avg_knower_pref + qt(0.975, df = n() - 1) * se,
    n_trials = sum(trials))   # Upper 95% CI

bar_plot_2nd<-ggplot(data=data.plot.2nd,
  aes(x=condition, y= avg_knower_pref, fill=condition)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +  #Error bars at 95% CI
  geom_text(aes(x = 1, y = 0.69, label = "*"), size = 8) +  #p<0,05
  geom_text(aes(x = 2, y = 0.69, label = "*"), size = 8) +
  geom_text(aes(x = 3, y = 0.69, label = "*"), size = 8) +
  geom_hline(yintercept = 0.5, lty=2) +
  coord_cartesian(ylim = c(0.2, 0.7))+
  ylab("Average preference for the knower")+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )

bar_plot_2nd
```

###Plot with result of each session + both
```{r}
#Data from session 1 and 2
df_session <- xdata %>%  
  group_by(session, condition) %>%
  summarise(prop_choice = mean(choice_binary, na.rm = TRUE),
            n = n()) %>%
  mutate(
    se = sqrt(prop_choice * (1 - prop_choice) / n),
    ci_lower = prop_choice - 1.96 * se,
    ci_upper = prop_choice + 1.96 * se) %>%
  mutate(condition=fct_recode(condition, 
                              "Present" = "present",
                              "Absent" = "absent",
                              "Back turned" = "back_turned",
                              "Looking away" = "looking_away"),
         condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")) %>% 
  ungroup()

#Data from both session
df_both <- xdata %>%
  group_by(condition) %>%
  summarise(prop_choice = mean(choice_binary, na.rm = TRUE),
            n = n()) %>%
  mutate(
    session = "both",
    se = sqrt(prop_choice * (1 - prop_choice) / n),
    ci_lower = prop_choice - 1.96 * se,
    ci_upper = prop_choice + 1.96 * se) %>%
  mutate(condition=fct_recode(condition, 
                              "Present" = "present",
                              "Absent" = "absent",
                              "Back turned" = "back_turned",
                              "Looking away" = "looking_away"),
         condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away")) %>% 
  select(session, condition, prop_choice, n, se, ci_lower, ci_upper)

#Fusion the two of them
df_all <- bind_rows(
  df_session %>% mutate(session = as.character(session)),
  df_both) %>%
  mutate(session = recode(session,
                     "1" = "S1",
                     "2" = "S2",
                     "both" = "Both"),
    session = factor(session, levels = c("S1", "S2", "Both")),
    condition = fct_relevel(condition, "Present", "Absent", "Back turned", "Looking away"))



#Colors
my_colors <- c(
  "s1_present" = "darkolivegreen1",
  "s1_absent" = "lightblue",
  "s1_back_turned" = "lightsalmon",
  "s1_looking_away" = "plum2",
  "s2_present" = "darkolivegreen3",
  "s2_absent" = "cadetblue3",
  "s2_back_turned" = "coral1",
  "s2_looking_away" = "orchid3",
  "both_present" = "darkolivegreen",
  "both_absent" = "deepskyblue4",
  "both_back_turned" = "brown3",
  "both_looking_away" = "mediumorchid4")

df_all <- df_all %>%
  mutate(bar_id = paste0(tolower(as.character(session)), "_",
      tolower(gsub(" ", "_", condition))))
df_all$color <- my_colors[df_all$bar_id]
df_all$y_pos <- -0.02


plot_comparing_sessions<- ggplot(df_all, aes(x = condition, y = prop_choice, fill = color,group = session)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  scale_fill_identity()+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                position = position_dodge(width = 0.8),
                width = 0.2) +
  geom_text(aes(x = 1, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 0.75, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 1.25, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 2, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 3, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 2.75, y = 0.69, label = "*"), size = 6) +
  geom_text(aes(x = 3.25, y = 0.69, label = "*"), size = 6) +
  geom_hline(yintercept = 0.5, lty = 2) +
  geom_text(aes(label = session, y = y_pos),
            position = position_dodge(width = 0.8),
            color = "black",
            size = 3) +
  geom_text(aes(label = paste0("n=", n), y = 0.02),
            position = position_dodge(width = 0.8),
            color = "black",
            size = 3) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(-0.03,0.75)) +
  labs(x = NULL, y = "Percentage of choice for the Knower",
       fill = "Session") +
  theme_minimal() +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5,size = 14,vjust = 0))
```

print(plot_comparing_sessions)

#Learning process
##Across the session
```{r}
#See the results of "difference between conditions"
```

##Comparison with the first trial of the session
###First session
```{r}
#We are also going to do intercept only binomial models
#We create a data table with the 1st trial (ft) of each condition for each dog
ft.1st.data<-xdata %>% 
  filter (session ==1)  %>% 
  group_by(dog_name, condition) %>%
  mutate(trial_within_cond = rank(trial, ties.method = "first")) %>% #we give a rank to each trial within the condition
  ungroup() %>% 
  filter(trial_within_cond==1) #we only keep the trials of rank 1
```

```{r}
#First session, first trial of only test condition
ft.1st.data.test<- ft.1st.data %>% 
  filter(condition!="present") #we remove the present condition

ft.iobm.1st.test=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.1st.data.test, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.1st.test <- confint(ft.iobm.1st.test, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.1st.test)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.1st.test["(Intercept)", ])

cat("Ft Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.535 
#95% Confidence intervalle of probability: 0.477 - 0.593   

summary(ft.iobm.1st.test) 
#p-value = 0.234
#z-value =  1.19
#std error = 0.1194

```

```{r}
#First session, first trial of present condition
ft.1st.data.present<- ft.1st.data %>% 
  filter(condition=="present")

ft.iobm.1st.present=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.1st.data.present, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.1st.present <- confint(ft.iobm.1st.present, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.1st.present)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.1st.present["(Intercept)", ])

cat("Ft Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.585  
#95% Confidence intervalle of probability: 0.483 - 0.68   

summary(ft.iobm.1st.present) 
#p-value = 0.101
#z-value = 1.641
#std error = 0.2095
```

```{r}
#First session, first trial of absent condition
ft.1st.data.absent<- ft.1st.data %>% 
  filter(condition=="absent")

ft.iobm.1st.absent=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.1st.data.absent, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.1st.absent <- confint(ft.iobm.1st.absent, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.1st.absent)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.1st.absent["(Intercept)", ])

cat("Ft Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.521 
#95% Confidence intervalle of probability:0.421 - 0.62  

summary(ft.iobm.1st.absent) 
#p-value = 0.68
#z-value = 0.412
#std error = 0.20652
```

```{r}
#First session, first trial of back turned condition
ft.1st.data.back.turned<- ft.1st.data %>% 
  filter(condition=="back_turned")

ft.iobm.1st.back.turned=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.1st.data.back.turned, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.1st.back.turned <- confint(ft.iobm.1st.back.turned, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.1st.back.turned)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.1st.back.turned["(Intercept)", ])

cat("Ft Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.596 
#95% Confidence intervalle of probability:0.494 - 0.69  

summary(ft.iobm.1st.back.turned) 
#p-value = 0.0652
#z-value = 1.844
#std error = 0.2103
```

```{r}
#First session, first trial of looking away condition
ft.1st.data.looking.away<- ft.1st.data %>% 
  filter(condition=="looking_away")

ft.iobm.1st.looking.away=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.1st.data.looking.away, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.1st.looking.away <- confint(ft.iobm.1st.looking.away, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.1st.looking.away)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.1st.looking.away["(Intercept)", ])

cat("Ft Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.489  
#95% Confidence intervalle of probability:0.39 - 0.589  

summary(ft.iobm.1st.looking.away) 
#p-value = 0.837
#z-value = -0.206
#std error = 0.20634
```

```{r}
#Plot comparing the results in the 1st to the the rest of the session
data.plot.ft.1st <- data.plot.1st  #see in #Analytic stats,##Individual level, ###First session 
data.plot.ft.1st$studies <- factor(c("us","us","us","us"))
data.plot.ft.1st$bar_color <-c("darkolivegreen","deepskyblue4","coral1","mediumorchid4" )

present_ft <- data.frame(
      condition = "Present",
      avg_knower_pref = 0.581,
      se = NA,
      ci_lower = 0.478,
      ci_upper = 0.676,
      studies = "ft",
      bar_color="darkolivegreen1",
      n_trials=93)
absent_ft <- data.frame(
      condition = "Absent",
      avg_knower_pref = 0.527,
      se = NA,
      ci_lower = 0.425,
      ci_upper = 0.626,
      studies = "ft",
      bar_color="lightblue",
      n_trials=93)
back_turned_ft <-data.frame(
      condition = "Back turned",
      avg_knower_pref = 0.602,
      se = NA,
      ci_lower = 0.50,
      ci_upper = 0.696,
      studies = "ft",
      bar_color="lightsalmon",
      n_trials=93)
looking_away_ft <- data.frame(
      condition = "Looking away",
      avg_knower_pref = 0.484,
      se = NA,
      ci_lower = 0.384,
      ci_upper = 0.585,
      studies = "ft",
      bar_color="plum2",
      n_trials=93)

data.plot.ft.1st <- rbind(data.plot.ft.1st,present_ft)
data.plot.ft.1st <- rbind(data.plot.ft.1st,absent_ft)
data.plot.ft.1st <- rbind(data.plot.ft.1st,back_turned_ft)
data.plot.ft.1st <- rbind(data.plot.ft.1st,looking_away_ft)

data.plot.ft.1st$studies <- factor(data.plot.ft.1st$studies, levels = c("ft", "us"))
data.plot.ft.1st$condition <- factor(data.plot.ft.1st$condition, 
                                        levels = c("Present", "Absent", "Back turned", "Looking away"))
data.plot.ft.1st$bar_id <- as.character(interaction(data.plot.ft.1st$condition, data.plot.ft.1st$studies))

bar_plot_ft_1st <- ggplot(data = data.plot.ft.1st, 
  aes(x = condition, y = avg_knower_pref, fill = bar_id, group =studies)) + 
  geom_bar(stat = "identity", position = position_dodge(width =0.9)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                width = 0.2, 
                position = position_dodge(width = 0.9)) +
  geom_text(aes(x = 1.23, y = 0.73, label = "*"), size = 8) +
  geom_text(aes(x = 3.23, y = 0.73, label = "*"), size = 8) +
  geom_hline(yintercept = 0.5, lty = 2) +
  geom_text(aes(label = paste0("n=", n_trials), y = 0.2),
            position = position_dodge(width = 0.8),
            color = "black",
            size = 4) +
  coord_cartesian(ylim = c(0.2, 0.85)) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +  
  ylab("Percentage of choice for the Knower") +  
  scale_fill_manual( values = setNames(data.plot.ft.1st$bar_color, data.plot.ft.1st$bar_id))+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )

```

###Second session
```{r}
#We create a data table with the 1st trial (ft) of the 2nd session of each condition for each dog
ft.2nd.data<-xdata %>% 
  filter (session ==2)  %>% 
  group_by(dog_name, condition) %>%
  mutate(trial_within_cond = rank(trial, ties.method = "first")) %>%
  ungroup() %>% 
  filter(trial_within_cond==1) 
```

```{r}
#Second session, first trial of only test condition
ft.2nd.data.test<- ft.2nd.data %>% 
  filter(condition!="present") #we remove the present condition

ft.iobm.2nd.test=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.2nd.data.test, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.2nd.test <- confint(ft.iobm.2nd.test, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.2nd.test)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.2nd.test["(Intercept)", ])

cat("Ft Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability:  0.556 
#95% Confidence intervalle of probability:  0.494 - 0.616  

summary(ft.iobm.2nd.test) 
#p-value = 0.0758
#z-value = 1.775
#std error = 0.1263 

```

```{r}
#Second session, first trial of present condition
ft.2nd.data.present<- ft.2nd.data %>% 
  filter(condition=="present")

ft.iobm.2nd.present=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.2nd.data.present, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.2nd.present <- confint(ft.iobm.2nd.present, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.2nd.present)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.2nd.present["(Intercept)", ])

cat("Ft Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability:   0.69 
#95% Confidence intervalle of probability:    0.585 - 0.778 

summary(ft.iobm.2nd.present) 
#p-value =  0.00057
#z-value =  3.446 
#std error = 0.2317
```

```{r}
#Second session, first trial of absent condition
ft.2nd.data.absent<- ft.2nd.data %>% 
  filter(condition=="absent")

ft.iobm.2nd.absent=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.2nd.data.absent, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.2nd.absent <- confint(ft.iobm.2nd.absent, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.2nd.absent)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.2nd.absent["(Intercept)", ])

cat("Ft Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.563
#95% Confidence intervalle of probability :  0.458 - 0.663

summary(ft.iobm.2nd.absent) 
#p-value =  0.24
#z-value = 1.175
#std error =   0.2164 
```

```{r}
#Second session, first trial of back turned condition
ft.2nd.data.back.turned<- ft.2nd.data %>% 
  filter(condition=="back_turned")

ft.iobm.2nd.back.turned=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.2nd.data.back.turned, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.2nd.back.turned <- confint(ft.iobm.2nd.back.turned, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.2nd.back.turned)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.2nd.back.turned["(Intercept)", ])

cat("Ft Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability:  0.667 
#95% Confidence intervalle of probability:0.562 - 0.757

summary(ft.iobm.2nd.back.turned) 
#p-value = 0.00231
#z-value = 3.048 
#std error =  0.2274 
```

```{r}
#Second session, first trial of looking away condition
ft.2nd.data.looking.away<- ft.2nd.data %>% 
  filter(condition=="looking_away")

ft.iobm.2nd.looking.away=glmer(choice_binary ~ 1 +
                   (1|dog_id),
             data=ft.2nd.data.looking.away, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_ft.iobm.2nd.looking.away <- confint(ft.iobm.2nd.looking.away, method = "Wald")
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(ft.iobm.2nd.looking.away)[1])
confint_prob <- logit_to_prob(confint_ft.iobm.2nd.looking.away["(Intercept)", ])

cat("Ft Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Ft Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability:  0.437 
#95% Confidence intervalle of probability: 0.337 - 0.542 

summary(ft.iobm.2nd.looking.away) 
#p-value =  0.24
#z-value = -1.175
#std error = 0.2164 
```

```{r}
#Plot comparing the results in the 1st to the the rest of the session
data.plot.ft.2nd <- data.plot.2nd  #see in #Analytic stats,##Individual level, ###First session 
data.plot.ft.2nd$studies <- factor(c("us","us","us","us"))
data.plot.ft.2nd$bar_color <-c("darkolivegreen","deepskyblue4","coral1","mediumorchid4" )

present_ft <- data.frame(
      condition = "Present",
      avg_knower_pref = 0.69,
      se = NA,
      ci_lower = 0.585 ,
      ci_upper = 0.778,
      studies = "ft",
      bar_color="darkolivegreen1",
      n_trials=87)
absent_ft <- data.frame(
      condition = "Absent",
      avg_knower_pref = 0.563,
      se = NA,
      ci_lower = 0.458,
      ci_upper =0.663 ,
      studies = "ft",
      bar_color="lightblue",
      n_trials=87)
back_turned_ft <-data.frame(
      condition = "Back turned",
      avg_knower_pref =  0.667  ,
      se = NA,
      ci_lower =  0.562 ,
      ci_upper = 0.757 ,
      studies = "ft",
      bar_color="lightsalmon",
      n_trials=87)
looking_away_ft <- data.frame(
      condition = "Looking away",
      avg_knower_pref = 0.437 ,
      se = NA,
      ci_lower = 0.337 ,
      ci_upper = 0.542,
      studies = "ft",
      bar_color="plum2",
      n_trials=87)

data.plot.ft.2nd <- rbind(data.plot.ft.2nd,present_ft)
data.plot.ft.2nd <- rbind(data.plot.ft.2nd,absent_ft)
data.plot.ft.2nd <- rbind(data.plot.ft.2nd,back_turned_ft)
data.plot.ft.2nd <- rbind(data.plot.ft.2nd,looking_away_ft)

data.plot.ft.2nd$studies <- factor(data.plot.ft.2nd$studies, levels = c("ft", "us"))
data.plot.ft.2nd$condition <- factor(data.plot.ft.2nd$condition, 
                                        levels = c("Present", "Absent", "Back turned", "Looking away"))
data.plot.ft.2nd$bar_id <- as.character(interaction(data.plot.ft.2nd$condition, data.plot.ft.2nd$studies))

bar_plot_ft_2nd <- ggplot(data = data.plot.ft.2nd, 
  aes(x = condition, y = avg_knower_pref, fill = bar_id, group =studies)) + 
  geom_bar(stat = "identity", position = position_dodge(width =0.9)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                width = 0.2, 
                position = position_dodge(width = 0.9)) +
  geom_text(aes(x = 1.23, y = 0.8, label = "*"), size = 8) +
  geom_text(aes(x = 0.77, y = 0.8, label = "*"), size = 8) +
  geom_text(aes(x = 2.77, y = 0.8, label = "*"), size = 8) +
  geom_text(aes(x = 3.23, y = 0.8, label = "*"), size = 8) +
  geom_text(aes(x = 2.23, y = 0.8, label = "*"), size = 8) +
  geom_hline(yintercept = 0.5, lty = 2) +
  geom_text(aes(label = paste0("n=", n_trials), y = 0.2),
            position = position_dodge(width = 0.8),
            color = "black",
            size = 4) +
  coord_cartesian(ylim = c(0.2, 0.85)) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +  
  ylab(NULL) +  
  scale_fill_manual( values = setNames(data.plot.ft.2nd$bar_color, data.plot.ft.2nd$bar_id))+
  theme_bw()+
  theme(legend.position = "none",
    axis.title.x = element_blank(),       
    axis.text.x = element_text(size = 14) )

```

bar_plot_ft_1st + bar_plot_ft_2nd + plot_layout(ncol = 2)

#Impact model
##Overall session
```{r}
#We will see if the n° of the trial, the n° of the session, the age, the sex or the condition have a significant impact on the results

between.model.data <- xdata %>%
  mutate(condition = fct_recode(condition,         #rename the conditions
                                "Present" = "present",
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away")) %>%
  mutate(condition = fct_relevel(condition, "Present")) %>%  # We set "present" as reference (control condition, his level will be [1])
  mutate(z.age=as.vector(scale(age, center = TRUE, scale=TRUE)),
         z.trial=as.vector(scale(trial, center = TRUE, scale=TRUE)),
         z.session=as.vector(scale(session, center = TRUE, scale=TRUE)),
         sex.c=
           as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         condition.abs.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[2]), center=TRUE, scale= FALSE)),
         condition.bt.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[3]), center=TRUE, scale= FALSE)),
         condition.la.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[4]), center=TRUE, scale= FALSE)))

#numerical variables :age, trial, session
#scale() : standardization of the variable by subtracting the mean (center) and then dividing by the standard deviation (scale), therefore all are variable z-centered have a mean of 0 and a standard deviation of 1.
#as.vetor() : we convert this result into a vector (because scale automatically gives back a matrix)

#for the conditions (same for sex) : 
#the variable condition has character values so we change it as factor of 4 levels (actually it is already put has factor but it safer this way) 
#we compare each element of condition to level corresponding ([2] absent, [3] back turned, [4] looking away)
#as.numeric() converts the logical into numeric : for example if the element is "absent" and is compared to level 2, as.numeric will convert the TRUE into a 1.
#so we have a binary numeric variable : 1 if the elements equal the corresponding level, 0 otherwise
#We center the variable but we do not scale it and then convert it to a vector 
#Centering improves the interpretation of model coefficients and reduces the collinearity in mixed models (which we will be using)

levels(as.factor(between.model.data$condition)) #To check if it worked and if the levels are in the right order
```

```{r}
#We run the model
between.model=glmer(choice_binary ~ condition + z.age + z.trial + sex.c +z.session+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial+z.session|dog_id),
         data=between.model.data, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

#See the results
round(summary(between.model)$coefficients,3)
summary(between.model)$varcor
#The more the Std deviation is high, the more we have a high variation of the results depending of this variable between dogs 

#more precise p-value with post hoc
emm <- emmeans(between.model, ~ condition)

# paired comparison with Present
contrast(emm, method = "trt.vs.ctrl", ref = "Present", adjust = "bonferroni")

#    Estimate Std. Error z value Pr(>|z|)
#(Intercept)               0.30       0.06    4.72     0.00
#conditionAbsent          -0.20       0.09   -2.23     0.03
#conditionBack turned      0.09       0.09    0.97     0.33
#conditionLooking away    -0.30       0.10   -3.16     0.00
#z.age                     0.03       0.03    0.83     0.41
#z.trial                  -0.05       0.03   -1.61     0.11
#sex.c                     0.00       0.06   -0.01     0.99
#z.session                 0.04       0.03    1.27     0.20
# Groups Name            Std.Dev. Corr                              
# dog_id (Intercept)     0.000000                                   
#        condition.abs.c 0.205609    NaN                            
#        condition.bt.c  0.216374    NaN  0.800                     
#        condition.la.c  0.355870    NaN -0.380  0.252              
#        z.trial         0.080155    NaN  0.996  0.853 -0.291       
#        z.session       0.058673    NaN  0.695  0.124 -0.929  0.624
# contrast               estimate     SE  df z.ratio p.value
# Absent - Present        -0.2004 0.0899 Inf  -2.229  0.0775
# Back turned - Present    0.0885 0.0909 Inf   0.973  0.9910
# Looking away - Present  -0.3006 0.0952 Inf  -3.159  0.0047
```

```{r}
#We remove every fixed effect one by one and compared it to the complete model with a Chi² test (likelihood ratio test) 
drop.between.model <- round(drop1(between.model, test="Chisq"),3)

aic_between_model <- drop.between.model[1, "AIC"] #AIC of the complet model
aic_between_model_drop <- drop.between.model[, "AIC"][-1] #AIC of the reduced models
delta_aic_between_model <- c(round(aic_between_model - aic_between_model_drop, 2))  #ΔAIC between full and reduced model

#We do a table to summary of all this results
drop_results <- drop.between.model
drop_results$delta_AIC <- c(NA, delta_aic_between_model) # add the column delta AIC
drop_results

#so when we remove the variable condition : we have an AIC (the higher it is the more removing this effect worsen the model), we have a p-value (removing as a significant effect or not), we have a delta_AIC (if >2, the effect was important)

#         npar    AIC    LRT Pr(Chi) delta_AIC
#<none>         5956.0                         
#condition    3 5963.3 13.308   0.004     -7.31
#z.age        1 5954.7  0.690   0.406      1.31
#z.trial      1 5956.5  2.561   0.110     -0.56
#sex.c        1 5954.0  0.000   0.994      2.00
#z.session    1 5955.6  1.610   0.204      0.39
```

```{r}
#remove manually the condition fixed effect from the model
red<-glmer(choice_binary ~ z.age + z.trial + sex.c +z.session+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial+z.session|dog_id),
         data=between.model.data, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
full<-between.model

#compate the reduced and the complete models
anova_result<-as.data.frame(anova(red, full, test="Chisq"))
print (anova_result)

#same results
```

##First session
```{r}
between.model.data.1st <- xdata %>%
  filter (session ==1)  %>% 
  mutate(condition = fct_recode(condition,        
                                "Present" = "present",
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away")) %>%
  mutate(condition = fct_relevel(condition, "Present")) %>% 
  mutate(z.age=as.vector(scale(age, center = TRUE, scale=TRUE)),
         z.trial=as.vector(scale(trial, center = TRUE, scale=TRUE)),
         sex.c=
           as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         condition.abs.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[2]), center=TRUE, scale= FALSE)),
         condition.bt.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[3]), center=TRUE, scale= FALSE)),
         condition.la.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[4]), center=TRUE, scale= FALSE)))
```

```{r}
#We run the model
between.model.1st=glmer(choice_binary ~ condition + z.age + z.trial + sex.c+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial|dog_id),
         data=between.model.data.1st, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

#See the results
round(summary(between.model.1st)$coefficients,3)
summary(between.model.1st)$varcor

#more precise p-value with post hoc
emm <- emmeans(between.model.1st, ~ condition)

# paired comparison with Present
contrast(emm, method = "trt.vs.ctrl", ref = "Present", adjust = "bonferroni")

# Estimate Std. Error z value Pr(>|z|)
#(Intercept)              0.240      0.086   2.793    0.005
#conditionAbsent         -0.303      0.122  -2.490    0.013
#conditionBack turned     0.197      0.125   1.580    0.114
#conditionLooking away   -0.224      0.122  -1.839    0.066
#z.age                    0.048      0.043   1.112    0.266
#z.trial                 -0.037      0.044  -0.848    0.397
#sex.c                    0.043      0.087   0.495    0.621
# Groups Name            Std.Dev. Corr                       
# dog_id (Intercept)     0.000000                            
#        condition.abs.c 0.133307    NaN                     
#        condition.bt.c  0.227023    NaN  1.000              
#        condition.la.c  0.125021    NaN -1.000 -1.000       
#        z.trial         0.092966    NaN  1.000  1.000 -1.000
# contrast               estimate    SE  df z.ratio p.value
# Absent - Present         -0.303 0.122 Inf  -2.490  0.0383
# Back turned - Present     0.197 0.125 Inf   1.580  0.3425
# Looking away - Present   -0.224 0.122 Inf  -1.839  0.1978
```

```{r}
#We remove every fixed effect one by one and compared it to the complete model with a Chi² test (likelihood ratio test) 
drop.between.model <- round(drop1(between.model.1st, test="Chisq"),4)

aic_between_model <- drop.between.model[1, "AIC"] #AIC of the complet model
aic_between_model_drop <- drop.between.model[, "AIC"][-1] #AIC of the reduced models
delta_aic_between_model <- c(round(aic_between_model - aic_between_model_drop, 2))  #ΔAIC between full and reduced model

#We do a table to summary of all this results
drop_results <- drop.between.model
drop_results$delta_AIC <- c(NA, delta_aic_between_model) # add the column delta AIC
drop_results

#         npar    AIC     LRT Pr(Chi) delta_AIC
#<none>         3089.6                          
#condition    3 3102.1 18.5345  0.0003    -12.53
#z.age        1 3087.9  0.4018  0.5262      1.60
#z.trial      1 3087.5 -0.0690  1.0000      2.07
#sex.c        1 3087.8  0.2450  0.6206      1.75

```

```{r}
#remove manually the condition fixed effect from the model
red.1st<-glmer(choice_binary ~ z.age + z.trial + sex.c+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial|dog_id),
         data=between.model.data.1st, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
round(summary(red.1st)$coefficients,2)
summary(red.1st)$varcor
full.1st<-between.model.1st

#compate the reduced and the complete models
anova_result<-as.data.frame(anova(red.1st, full.1st, test="Chisq"))
print (anova_result)

#same results
```

##Second session
```{r}
between.model.data.2nd <- xdata %>%
  filter (session ==2)  %>% 
  mutate(condition = fct_recode(condition,        
                                "Present" = "present",
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away")) %>%
  mutate(condition = fct_relevel(condition, "Present")) %>% 
  mutate(z.age=as.vector(scale(age, center = TRUE, scale=TRUE)),
         z.trial=as.vector(scale(trial, center = TRUE, scale=TRUE)),
         sex.c=
           as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         condition.abs.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[2]), center=TRUE, scale= FALSE)),
         condition.bt.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[3]), center=TRUE, scale= FALSE)),
         condition.la.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[4]), center=TRUE, scale= FALSE)))

```

```{r}
#We run the model
between.model.2nd=glmer(choice_binary ~ condition + z.age + z.trial + sex.c+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial|dog_id),
         data=between.model.data.2nd, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

#See the results
round(summary(between.model.2nd)$coefficients,2)
summary(between.model.1st)$varcor

#more precise p-value with post hoc
emm <- emmeans(between.model.2nd, ~ condition)

# paired comparison with Present
contrast(emm, method = "trt.vs.ctrl", ref = "Present", adjust = "bonferroni")


#                      Estimate Std. Error z value Pr(>|z|)
#(Intercept)               0.36       0.09    4.02     0.00
#conditionAbsent          -0.08       0.13   -0.67     0.50
#conditionBack turned     -0.02       0.13   -0.15     0.88
#conditionLooking away    -0.38       0.13   -3.04     0.00
#z.age                     0.00       0.04   -0.01     0.99
#z.trial                  -0.07       0.04   -1.52     0.13
#sex.c                    -0.04       0.09   -0.49     0.62
# Groups Name            Std.Dev. Corr                       
# dog_id (Intercept)     0.000000                            
#        condition.abs.c 0.133307    NaN                     
#        condition.bt.c  0.227023    NaN  1.000              
#        condition.la.c  0.125021    NaN -1.000 -1.000       
#        z.trial         0.092966    NaN  1.000  1.000 -1.000
# contrast               estimate    SE  df z.ratio p.value
# Absent - Present        -0.0842 0.125 Inf  -0.671  1.0000
# Back turned - Present   -0.0189 0.126 Inf  -0.150  1.0000
# Looking away - Present  -0.3797 0.125 Inf  -3.035  0.0072
```

```{r}
#We remove every fixed effect one by one and compared it to the complete model with a Chi² test (likelihood ratio test) 
drop.between.model <- round(drop1(between.model.2nd, test="Chisq"),5)

aic_between_model <- drop.between.model[1, "AIC"] #AIC of the complet model
aic_between_model_drop <- drop.between.model[, "AIC"][-1] #AIC of the reduced models
delta_aic_between_model <- c(round(aic_between_model - aic_between_model_drop, 2))  #ΔAIC between full and reduced model

#We do a table to summary of all this results
drop_results <- drop.between.model
drop_results$delta_AIC <- c(NA, delta_aic_between_model) # add the column delta AIC
drop_results

#         npar    AIC     LRT Pr(Chi) delta_AIC
#<none>         2894.0                          
#condition    3 2893.2  5.2839 0.15215      0.72
#z.age        1 2886.1 -5.9051 1.00000      7.91
#z.trial      1 2888.5 -3.4551 1.00000      5.46
#sex.c        1 2886.2 -5.7837 1.00000      7.78

```

```{r}
#remove manually the condition fixed effect from the model
red<-glmer(choice_binary ~ z.age + z.trial + sex.c+
        (1+condition.abs.c+condition.bt.c+condition.la.c+z.trial|dog_id),
         data=between.model.data.2nd, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
full<-between.model.2nd

#compate the reduced and the complete models
anova_result<-as.data.frame(anova(red, full, test="Chisq"))
print (anova_result)

#same results
```

#Preference
##For a cup
###Overall dogs
```{r}
#We should have the same probability of choice for the cups 1, 2, 3, 4
pref_cup <- table (xdata$choice_number)
number_of_choice = sum (pref_cup)
test_pref_cup <- chisq.test (pref_cup)
test_pref_cup                                

prop.table(pref_cup)

pairwise.prop.test(x = pref_cup, n= rep(100, 4), p.adjust.method = "bonferroni")

```

###Individualy
```{r}
dog_pref_cup <- xdata %>%
  group_by(dog_name) %>%
  summarise(
    dog_name = dog_name[1],
    n_trials = n(),
    choice_table = list(table(choice_number)),
    .groups = "drop") %>%
  mutate(chisq_test = lapply(choice_table, function(x) if(length(x) > 1)     chisq.test(x) else NA),
    p_value = sapply(chisq_test, function(x) if (!is.na(x)[1]) x$p.value else NA),
    p_value = round(p_value, 3),
    significant = ifelse(!is.na(p_value), p_value < 0.05, FALSE),
    preferred_cup = ifelse(significant,
                           sapply(choice_table, function(x) names(which.max(x))),
                           NA))
dog_pref_cup
```

##For a side/experimenter
###Overall dogs
```{r}
#We should have the same probability of choice for the R or the L
pref_LR <- table (xdata$choice_LR)
number_of_choice = sum (pref_LR)
test_pref_LR <- binom.test(pref_LR["L"], number_of_choice, p = 0.5)
test_pref_LR                                

prop.table(pref_LR)

###dogs chosed significantly more the L than the R pointing (might be because we start by baiting from the left side ?)
```

###Individualy
```{r}
#We are going to use a binomial test
dog_pref_LR <- xdata %>%
   filter(!is.na(choice_LR)) %>%
  group_by(dog_name, session) %>%
  summarise(n_trials = n(),
    n_L = sum(choice_LR == "L"),
    n_R = sum(choice_LR == "R"),
    .groups = "drop") %>%
  mutate(binom_test = purrr::pmap(list(n_L, n_trials), ~ binom.test(..1, ..2, p = 0.5)),
    p_value = sapply(binom_test, function(x) x$p.value),
    p_value = round(p_value, 3),
    significant = p_value < 0.05,
    preferred_side = case_when(significant & n_L > n_R ~ "L",significant & n_R > n_L ~ "R",TRUE ~ NA_character_))
dog_pref_LR

```

##Does this influence our results ?
###Removing the dogs that have a significant preference
```{r}
#List of the dogs having a significant side preference and in what sessions
side_pref_dogs_session <- dog_pref_LR %>%
  filter(significant == TRUE) %>%
  select(dog_name, session)

#Removing these data
xdata_filtered <- xdata %>%
  anti_join(side_pref_dogs_session, by = c("dog_name", "session"))
```

```{r}
#Overall sessions, only test conditions, No side biais dogs
test.data.overall<-xdata_filtered %>% 
  filter(condition!="present") #we remove the control condition
# Run the model
iobm.overall.test=glmer(choice_binary ~ 1 + (1|dog_id), 
      #~1 is the intercept, compares to the average of success overall dogs 
      #no predictive variable, dog_id is set as a random variable, it means that each dogs can have a different number of success and we have multiple observations for eahc dog
             data=test.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
      #"bobyqa" = optimizer, which is generally more robust and efficient
      #optCtrl = increases the maximum number of function evaluations to 200,000 usefull if convergence is slow.

confint_iobm.overall.test <- confint(iobm.overall.test, method = "Wald") #confidence intervalle
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit)) #fonction to go from OR to proba
prob_intercept <- logit_to_prob(fixef(iobm.overall.test)[1]) #estimated probability
confint_prob <- logit_to_prob(confint_iobm.overall.test["(Intercept)", ]) #intervalle of probability

cat("Test Estimated probability:", round(prob_intercept, 3), "\n",
    "Test 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.559 
#95% Confidence intervalle of probability:  0.533 - 0.584

summary(iobm.overall.test)
#p-value = 4.4 1.08e-0
#z-value =  4.4 
#std error =  0.05365
```

```{r}
#Overall sessions, Present condition, No side biais dogs
present.data.overall<-xdata_filtered  %>% 
  filter(condition=="present") 
iobm.overall.present=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=present.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.present <- confint(iobm.overall.present, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.present)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.present["(Intercept)", ]) 

cat("Present Estimated probability:", round(prob_intercept, 3), "\n",
    "Present 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.588 
#95% Confidence intervalle of probability: 0.543 - 0.632

summary(iobm.overall.present)
#p-value = 0.000146
#z-value = 3.798
#std error =  0.09381
```

```{r}
#Overall sessions, Absent condition, No side biais dogs
absent.data.overall<-xdata_filtered %>% 
  filter(condition=="absent") 
iobm.overall.absent=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=absent.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.absent <- confint(iobm.overall.absent, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.absent)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.absent["(Intercept)", ]) 

cat("Absent Estimated probability:", round(prob_intercept, 3), "\n",
    "Absent 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.544
#95% Confidence intervalle of probability: 0.497 - 0.59

summary(iobm.overall.absent)
#p-value =  0.0663
#z-value =  1.836 
#std error =  0.09595 
```

```{r}
#Overall sessions, Back turned condition, No side biais dogs
back.turned.data.overall<-xdata_filtered %>% 
  filter(condition=="back_turned") 
iobm.overall.back.turned=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=back.turned.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.back.turned <- confint(iobm.overall.back.turned, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.back.turned)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.back.turned["(Intercept)", ]) 

cat("Back turned Estimated probability:", round(prob_intercept, 3), "\n",
    "Back turned 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.625 
#95% Confidence intervalle of probability:  0.583 - 0.665 

summary(iobm.overall.back.turned)
#p-value = 1.46e-08
#z-value =  5.666
#std error =   0.08991
```

```{r}
#Overall sessions, Looking away condition, No side biais dogs
looking.away.data.overall<-xdata_filtered %>% 
  filter(condition=="looking_away") 
iobm.overall.looking.away=glmer(choice_binary ~ 1 + (1|dog_id), 
             data=looking.away.data.overall, family=binomial, 
            control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

confint_iobm.overall.looking.away <- confint(iobm.overall.looking.away, method = "Wald") 
logit_to_prob <- function(logit) exp(logit) / (1 + exp(logit))
prob_intercept <- logit_to_prob(fixef(iobm.overall.looking.away)[1])
confint_prob <- logit_to_prob(confint_iobm.overall.looking.away["(Intercept)", ]) 

cat("Looking away Estimated probability:", round(prob_intercept, 3), "\n",
    "Looking away 95% Confidence intervalle of probability:", round(confint_prob[1], 3), "-", round(confint_prob[2], 3), "\n")
#Estimated probability: 0.509 
#95% Confidence intervalle of probability: 0.468 - 0.55 

summary(iobm.overall.looking.away)
#p-value = 0.656
#z-value = 0.445
#std error = 0.08350
```

###Correlation between that preference and the choice for the knower
```{r}
#We create a new variable with the rate of preference per dog and session and we will run a glmm model to see if the index of preference in one session has an impact on the result in the tested condition (so without "present", because the dog doesn't make a mistake even by chosing the guesser in this condition) in the same session

#On both session, with the present condition
##We create a Lateralization index that we scale and center
pref.model.data <- xdata %>%
  group_by(dog_name, session) %>%
  mutate(
    sum_L = sum(choice_LR == "L", na.rm = TRUE),
    sum_R = sum(choice_LR == "R", na.rm = TRUE),
    total_trial = sum_L + sum_R,
    pref_index = abs((sum_R - sum_L) / total_trial)) %>%
  ungroup() %>%
   mutate(condition = fct_recode(condition,        
                                "Present" = "present",
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away")) %>%
  mutate(condition = fct_relevel(condition, "Present")) %>% 
  mutate(z.pref=as.vector(scale(pref_index, center = TRUE, scale=TRUE)),
         z.age=as.vector(scale(age, center = TRUE, scale=TRUE)),
         z.trial=as.vector(scale(trial, center = TRUE, scale=TRUE)),
         sex.c=
           as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         z.session=as.vector(scale(session, center = TRUE, scale=TRUE)),
         as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         condition.abs.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[2]), center=TRUE, scale= FALSE)),
         condition.bt.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[3]), center=TRUE, scale= FALSE)),
         condition.la.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[4]), center=TRUE, scale= FALSE)))

##Run the model
pref.model=glmer(choice_binary ~ condition+z.pref+z.age+z.trial+z.session+
        (1 + condition.abs.c+condition.bt.c+condition.la.c+z.pref+z.trial+z.session |dog_id),
         data=pref.model.data, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

#See the results
round(summary(pref.model)$coefficients,2)
#We don't have a significant effect by the lateralization index on choice binary in the test conditions 

#We remove every fixed effect one by one and compared it to the complete model with a Chi² test (likelihood ratio test) 
drop.pref.model <- round(drop1(pref.model, test="Chisq"),4)

aic_pref_model <- drop.pref.model[1, "AIC"] #AIC of the complet model
aic_pref_model_drop <- drop.pref.model[, "AIC"][-1] #AIC of the reduced models
delta_aic_pref_model <- c(round(aic_pref_model - aic_pref_model_drop, 2))  #ΔAIC between full and reduced model

#We do a table to summary of all this results
drop_results <- drop.pref.model
drop_results$delta_AIC <- c(NA, delta_aic_pref_model) # add the column delta AIC
drop_results

#                      Estimate Std. Error z value Pr(>|z|)
#(Intercept)               0.30       0.07    4.49     0.00
#conditionAbsent          -0.20       0.09   -2.19     0.03
#conditionBack turned      0.09       0.09    0.98     0.33
#conditionLooking away    -0.31       0.10   -3.23     0.00
#z.pref                   -0.09       0.04   -2.43     0.02
#z.age                     0.02       0.04    0.60     0.55
#z.trial                  -0.06       0.03   -1.66     0.10
#z.session                 0.06       0.03    1.72     0.09


#           npar    AIC     LRT Pr(Chi) delta_AIC
#<none>         5948.0                          
#condition    3 5964.3 22.3420  0.0001    -16.34
#z.pref       1 5951.9  5.9091  0.0151     -3.91
#z.age        1 5946.3  0.3639  0.5463      1.64
#z.trial      1 5948.7  2.7443  0.0976     -0.74
#z.session    1 5949.0  2.9671  0.0850     -0.97

```

```{r}
#On both session, without the present condition
##We create a Lateralization index that we scale and center
pref.model.data <- xdata %>%
  filter(condition!="present") %>%
  droplevels() %>% 
  group_by(dog_name, session) %>%
  mutate(
    sum_L = sum(choice_LR == "L", na.rm = TRUE),
    sum_R = sum(choice_LR == "R", na.rm = TRUE),
    total_trial = sum_L + sum_R,
    pref_index = abs((sum_R - sum_L) / total_trial)) %>%
  ungroup() %>%
   mutate(condition = fct_recode(condition,        
                                "Absent" = "absent",
                                "Back turned" = "back_turned", 
                                "Looking away" = "looking_away")) %>%
  mutate(z.pref=as.vector(scale(pref_index, center = TRUE, scale=TRUE)),
         z.age=as.vector(scale(age, center = TRUE, scale=TRUE)),
         z.trial=as.vector(scale(trial, center = TRUE, scale=TRUE)),
         sex.c=
           as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         z.session=as.vector(scale(session, center = TRUE, scale=TRUE)),
         as.vector(scale(as.numeric(sex == "f"), center = TRUE, scale = FALSE)),
         condition.abs.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[1]), center=TRUE, scale= FALSE)),
         condition.bt.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[2]), center=TRUE, scale= FALSE)),
         condition.la.c=
           as.vector(scale(as.numeric(condition==levels(as.factor(condition))[3]), center=TRUE, scale= FALSE)))


##Run the model
pref.model=glmer(choice_binary ~ condition+z.pref+z.age+z.trial+z.session+
        (1 + condition.abs.c+condition.bt.c+condition.la.c+z.pref+z.trial+z.session |dog_id),
         data=pref.model.data, family=binomial, 
         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

#See the results
round(summary(pref.model)$coefficients,2)
#We don't have a significant effect by the lateralization index on choice binary in the test conditions 

#We remove every fixed effect one by one and compared it to the complete model with a Chi² test (likelihood ratio test) 
drop.pref.model <- round(drop1(pref.model, test="Chisq"),4)

aic_pref_model <- drop.pref.model[1, "AIC"] #AIC of the complet model
aic_pref_model_drop <- drop.pref.model[, "AIC"][-1] #AIC of the reduced models
delta_aic_pref_model <- c(round(aic_pref_model - aic_pref_model_drop, 2))  #ΔAIC between full and reduced model

#We do a table to summary of all this results
drop_results <- drop.pref.model
drop_results$delta_AIC <- c(NA, delta_aic_pref_model) # add the column delta AIC
drop_results

#                      Estimate Std. Error z value Pr(>|z|)
#(Intercept)               0.10       0.07    1.42     0.16
#conditionBack turned      0.29       0.09    3.22     0.00
#conditionLooking away    -0.10       0.10   -1.01     0.31
#z.pref                   -0.06       0.04   -1.40     0.16
#z.age                     0.02       0.04    0.44     0.66
#z.trial                  -0.06       0.04   -1.58     0.11
#z.session                 0.04       0.04    1.20     0.23

#          npar    AIC     LRT Pr(Chi) delta_AIC
#<none>         4487.8                          
#condition    2 4502.8 18.9922  0.0001    -14.99
#z.pref       1 4487.8  1.9783  0.1596      0.02
#z.age        1 4486.0  0.1934  0.6601      1.81
#z.trial      1 4488.3  2.4860  0.1149     -0.49
#z.session    1 4487.3  1.4414  0.2299      0.56

```

##Is this linked to the first succeded trial ?
```{r}
#We check if when a dog has a preference during one session for the L experimenter, he was rewarded during the test by the L experimenter in this session (#need to run side_pref_dogs_session before)
ft_reward_pref <- xdata %>%
  group_by(dog_name,session)%>%
  mutate(reward_1st = (choice_binary == 1) | (condition == "present"))%>%
  filter(row_number() == which(reward_1st)[1])%>%
  left_join(dog_pref_LR %>% select(dog_name, session, preferred_side),
            by = c("dog_name", "session"))%>%
  mutate(match_preference = (choice_LR == preferred_side))%>%
  semi_join(side_pref_dogs_session, by = c("dog_name", "session"))
ft_reward_pref

#TRUE in match_preference means that it is the case

```

#Across the sessions
##Creation of a fonction that can give the p-value of the correlation from any matrix
```{r}
cor_pmat <- function(mat) 
  {n <- ncol(mat)
  p_mat <- matrix(NA, n, n) #empty matrix
  colnames(p_mat) <- rownames(p_mat) <- colnames(mat) #same column/row names
  for (i in 1:n) {for (j in 1:n) { #i=row, j=column
    if (i != j)  #to avoid the correlation of a variable with itself
      {test <- cor.test(mat[, i], mat[, j], use = "pairwise.complete.obs")
      p_mat[i, j] <- test$p.value} 
    else {p_mat[i, j] <- NA}}}
  return(p_mat)}
```

##Correlation across the sessions, per condition
```{r}
#Average of choice binary in each condition and for each session
cor_across_session_cond <- xdata %>%
  group_by(dog_id, session, condition) %>%
  summarise(mean_choice = mean(choice_binary), .groups = "drop")%>%
  pivot_wider(names_from = session, values_from = mean_choice,
              names_prefix = "session_") #1 colonne per session

cor_across_session_cond

#we are going to make a loop testing for each condition
conditions <- unique(cor_across_session_cond$condition) 
for (cond in conditions) {
  sub_data <- cor_across_session_cond %>% filter(condition == cond)
  name_cols <- c("session_1", "session_2") #add session_3 later
  if (all(name_cols %in% colnames(sub_data))) {
    cat("\n--- Condition:", cond, "---\n")
    sub_sessions <- sub_data %>%
      dplyr::filter(if_all(all_of(name_cols), ~ !is.na(.))) %>% #we remove the dogs that didn't participate in all sessions
      dplyr::select(all_of(name_cols)) %>% 
      dplyr::mutate(across(everything(), ~ as.numeric(as.character(.)))) %>%
      as.data.frame() #cor() only work with numeric so we convert the sessions columns as numeric
    cor_matrix <- cor(sub_sessions, use = "pairwise.complete.obs", method = "pearson") #we use "pairwise.complete.obs" because we might have NA in some session for some dogs
    print(cor_matrix)
    p_matrix <- cor_pmat(sub_sessions) #to have the p-values
    print(round(p_matrix, 4))
    corrplot(cor_matrix, method = "color", type = "upper", 
             p.mat = p_matrix, sig.level = 0.05, 
             insig = "pch", pch.cex = 1.5, #cross indicate if it is not significant
             tl.col = "black", tl.srt = 45,
             title = paste("Correlation across sessions in condition:", cond), mar = c(0,0,2,0))}
  else {message(paste("Condition", cond, "skipped: missing session columns"))}}

#absent : r=0.311021, p=0.0034
#back turned : r= 0.3105755 p =0.0034
#looking away : r=0.3667333 p = 5e-04
#present : r = 0.2351019 p =0.0284
```

##Correlation across sessions, for test conditions
```{r}
#Average of choice binary for each session
cor_across_session_tot <- xdata %>%
  filter(condition !="present")%>%
  group_by(dog_name, session) %>%
  summarise(mean_choice = mean(choice_binary, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = session, values_from = mean_choice,
              names_prefix = "session_")
sub_sessions <- cor_across_session_tot[, c("session_1", "session_2")] %>%#add session 3 later
  dplyr::select(session_1, session_2) %>%
  dplyr::mutate(across(everything(), ~ as.numeric(as.character(.)))) %>%
  dplyr::filter(if_all(everything(), ~ !is.na(.))) %>% #we only keep the dogs that participated in all sessions
  as.data.frame() 

#correlations
corr_matrix <- cor(sub_sessions, use = "pairwise.complete.obs", method = "pearson")
print(corr_matrix)

#p-values
p_matrix <- cor_pmat(sub_sessions)
print(round(p_matrix, 4))

#plot
corrplot(corr_matrix,method = "color", type = "upper",
         p.mat = p_matrix, sig.level = 0.05,
         insig = "pch", pch.cex = 1.5, 
         tl.col = "black", tl.srt = 45,
         title = "Correlation across sessions (all conditions)",
         mar = c(0, 0, 2, 0))

#r=0.3442956
#p=0.0013
```

##Plot performance in session 2-session 1
```{r}
scores_wide <- xdata %>%
  group_by(dog_name, condition, session) %>%
  summarise(mean_score = mean(choice_binary, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = session, values_from = mean_score, names_prefix = "session_") %>%
  filter(!is.na(session_1) & !is.na(session_2))  %>%
  mutate(condition = str_replace_all(condition, "_", " "),
         condition = str_to_title(condition))

# Calcul de la densité avec scores entre 0 et 1
dens <- with(scores_wide, MASS::kde2d(session_1, session_2, n = 100))

get_density <- function(x, y, dens){
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  mapply(function(i, j) ifelse(i > 0 & j > 0, dens$z[i,j], NA), ix, iy)}

scores_wide$density <- get_density(scores_wide$session_1, scores_wide$session_2, dens)

# Plot per condition
plot_by_condition<- ggplot(scores_wide, aes(x = session_1, y = session_2)) +
  geom_point(aes(color = density, size = density)) +
  scale_color_gradient2(low = "skyblue",mid = "plum", high = "red",
  midpoint = 4) +
  scale_size(range = c(1, 5), guide = "none") +
  geom_abline(intercept = 0, slope = 1, color = "black", linetype = "dashed") +
  facet_wrap(~ condition) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +  
  scale_x_continuous(labels = label_percent(accuracy = 1)) +  
  labs(x = "Percentage of choice for the Knower the first session",
       y = "Percentage of choice for the Knower the second session",
       color = "Number of dogs overlapping") +
  theme_minimal()

# Plot with all test condition pooled together
scores_wide_pooled <- scores_wide %>%
  filter(condition != "Present")

plot_pooled <- ggplot(scores_wide_pooled, aes(x = session_1, y = session_2)) +
  geom_point(aes(color = density, size = density)) +
  scale_color_gradient2(low = "skyblue", mid = "plum", high = "red",
                        midpoint = 4, , guide = "none") +
  scale_size(range = c(1, 5), guide = "none") +
  geom_abline(intercept = 0, slope = 1, color = "black", linetype = "dashed") +
  # Suppression de facet_wrap pour tout mettre dans un seul plot
  scale_y_continuous(labels = label_percent(accuracy = 1)) +  
  scale_x_continuous(labels = label_percent(accuracy = 1)) +  
  labs(x = "Percentage of choice for the Knower in the first session",
       y = "Percentage of choice for the Knower in the second session") +
  theme_minimal()

```

plot_pooled+ plot_by_condition + plot_layout(ncol = 2)

#Across the condition
```{r}
#overall session
cor_across_condition_tot <- xdata %>%
  group_by(dog_id, condition) %>%
  summarise(mean_choice = mean(choice_binary), .groups = "drop")%>%
  pivot_wider(names_from = condition, values_from = mean_choice)
sub_conditions <- cor_across_condition_tot[, -1] %>%
  dplyr::select(present, absent, back_turned, looking_away) %>%
  dplyr::mutate(across(everything(), ~ as.numeric(as.character(.)))) %>%
  as.data.frame() 

#correlations
corr_matrix <- cor(sub_conditions, use = "pairwise.complete.obs", method = "pearson")
print(corr_matrix)

#p_values
p_matrix <- cor_pmat(sub_conditions)
print(round(p_matrix, 4))

colnames(corr_matrix) <- str_to_title(str_replace_all(colnames(corr_matrix), "_", " "))
rownames(corr_matrix) <- colnames(corr_matrix)

```

corrplot(corr_matrix, method = "color",
  type = "upper",
  addCoef.col = "black", 
  tl.col = "black",      
  col = colorRampPalette(c("#2166AC", "#FFFFFF","#B2182B"))(200),  
  number.cex = 0.8,  
  tl.srt = 25)

```{r}
#First session
cor_across_condition_tot <- xdata %>%
   filter (session == 1)  %>%
  group_by(dog_id, condition) %>%
  summarise(mean_choice = mean(choice_binary), .groups = "drop")%>%
  pivot_wider(names_from = condition, values_from = mean_choice)
sub_conditions <- cor_across_condition_tot[, -1] %>%
  dplyr::select(present, absent, back_turned, looking_away) %>%
  dplyr::mutate(across(everything(), ~ as.numeric(as.character(.)))) %>%
  as.data.frame() 

#correlations
corr_matrix <- cor(sub_conditions, use = "pairwise.complete.obs", method = "pearson")
print(corr_matrix)

#p_values
p_matrix <- cor_pmat(sub_conditions)
print(round(p_matrix, 4))

colnames(corr_matrix) <- str_to_title(str_replace_all(colnames(corr_matrix), "_", " "))
rownames(corr_matrix) <- colnames(corr_matrix)

```

corrplot( corr_matrix, method = "color",
  type = "upper",
  addCoef.col = "black", 
  tl.col = "black",      
  col = colorRampPalette(c("#2166AC", "#FFFFFF","#B2182B"))(200),  
  number.cex = 0.8,  
  tl.srt = 25)

```{r}
#Second session
cor_across_condition_tot <- xdata %>%
  filter (session == 2)  %>%
  group_by(dog_id, condition) %>%
  summarise(mean_choice = mean(choice_binary), .groups = "drop")%>%
  pivot_wider(names_from = condition, values_from = mean_choice)
sub_conditions <- cor_across_condition_tot[, -1] %>%
  dplyr::select(present, absent, back_turned, looking_away) %>%
  dplyr::mutate(across(everything(), ~ as.numeric(as.character(.)))) %>%
  as.data.frame() 

#correlations
corr_matrix <- cor(sub_conditions, use = "pairwise.complete.obs", method = "pearson")
print(corr_matrix)

#p_values
p_matrix <- cor_pmat(sub_conditions)
print(round(p_matrix, 4))

colnames(corr_matrix) <- str_to_title(str_replace_all(colnames(corr_matrix), "_", " "))
rownames(corr_matrix) <- colnames(corr_matrix)
colnames(p_matrix) <- str_to_title(str_replace_all(colnames(p_matrix), "_", " "))
rownames(p_matrix) <- colnames(p_matrix)

```


corrplot( corr_matrix, method = "color",
  type = "upper",
  tl.col = "black",  
  addCoef.col = "black", 
  col = colorRampPalette(c("#2166AC", "#FFFFFF","#B2182B"))(200),  
  number.cex = 0.8,  
  tl.srt = 25) 
  
text(x=2.05, y=4.25, labels="*", col="black", cex=2)

#Split-half reliability
```{r}
xdata$split_half <- ifelse(xdata$trial %% 2 == 0, "even", "odd")

#Compute mean scores for odd and even trials per subject and condition (pooled across sessions)
odd_even_summary <- xdata %>%
  group_by(dog_name) %>%
  filter(n_distinct(session) == 2) %>%  # only on dogs who came at both session
  ungroup() %>%
  mutate(split_half = ifelse(trial %% 2 == 0, "even", "odd")) %>%
  group_by(dog_name, condition, split_half) %>%
  summarise(mean_score = mean(choice_binary, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = split_half, values_from = mean_score)

#Calculate Pearson correlation (split-half reliability) for each condition
condition_cor <- odd_even_summary %>%
  group_by(condition) %>%
  summarise(split_half_r = cor(odd, even, use = "complete.obs"))

#Also compute the correlation pooled across all conditions
overall_split_half_r <- cor(odd_even_summary$odd, odd_even_summary$even, use = "complete.obs")

# Spearman-Brown correction : To estimate the full-test reliability based on the split-half
condition_cor <- condition_cor %>%
  mutate(spearman_brown = (2 * split_half_r) / (1 + split_half_r))

overall_spearman_brown <- (2 * overall_split_half_r) / (1 + overall_split_half_r)

#Print everything 
print(condition_cor)
cat("Overall split-half reliability (r):", overall_split_half_r, "\n")
cat("Spearman-Brown corrected reliability:", overall_spearman_brown, "\n")

#Overall split-half reliability (r): -0.0837293 
#Spearman-Brown corrected reliability: -0.1827611 
```

#Stability 
```{r}
#Code from Lucrezia Lonardo
m.stab.c <- glmm.model.stab(model.res = between.model)
m.stab.c$detailed$warnings
as.data.frame(round(m.stab.c$summary[, -1], 4))

m.stab.plot(round(m.stab.c$summary[, -1], 2))

#             orig           min      max
#(Intercept)	0.2994	0.2852	0.3170
#conditionAbsent	-0.2004	-0.2228	-0.1791
#conditionBack turned	0.0885	0.0662	0.1156
#conditionLooking away	-0.3006	-0.3241	-0.2692
#z.age	0.0259	0.0163	0.0353
#z.trial	-0.0519	-0.0651	-0.0455
#sex.c	-0.0005	-0.0333	0.0268
#z.session	0.0400	0.0318	0.0472

```

#Intervalle
```{r}
#Code from Lucrezia Lonardo
mm1_choice.ci=boot.glmm.pred(model.res=between.model, excl.warnings=F,
nboots=1000, para=T, n.cores="all-1", resol=1000, level=0.95)

round(mm1_choice.ci$ci.estimates,3)

#orig    X2.5.     X97.5.
#(Intercept)	0.299	0.181	0.430	
#conditionAbsent	-0.200	-0.382	-0.020	
#conditionBack turned	0.089	-0.073	0.270	
#conditionLooking away	-0.301	-0.494	-0.124	
#z.age	0.026	-0.030	0.089	
#z.trial	-0.052	-0.116	0.012	
#sex.c	-0.001	-0.127	0.135	
#z.session	0.040	-0.022	0.105	
```

#Inter-observer reliability (choice - binary variable, repeated obs. per subj)
```{r}
#Code from Lucrezia Lonardo
#read in reliability scorings
reliab.data <- read_delim(file.choose(), delim = ",", locale = locale(decimal_mark = "."))
reliab.data<- reliab.data %>%
  mutate(original_code_fct=as.factor(original_code),
         recoding_fct=as.factor(recoding))

str(reliab.data)
unique(levels(as.factor(reliab.data$dog_name))) #60 dogs coded
which(is.na(reliab.data$original_code)) #contains one NA, recoded as missing to calculate % agreement

reliab.data$original_code[is.na(reliab.data$original_code)] <- "missing"

#Calculate Percentage Agreement
percentage_agreement <- sum(reliab.data$recoding == reliab.data$original_code, na.rm = TRUE) / sum(!is.na(reliab.data$recoding) & !is.na(reliab.data$original_code)) * 100
percentage_agreement #99.26026%

library(tidyr)
long.reliab.data <- pivot_longer(reliab.data, cols = c(recoding, original_code),
                          names_to = "rater", values_to = "rating")

str(long.reliab.data)
summary(long.reliab.data$rating)

table(long.reliab.data$rating)
str(long.reliab.data$rating)
long.reliab.data$rating <- factor(long.reliab.data$rating, levels = c("L", "R"))

#binomial GLMM to test if the rater has an influence on the rating
reliab.glmm <- glmer(rating ~ rater + (1 | dog_name), data = long.reliab.data,
               family = binomial)

round(summary(reliab.glmm)$coefficients,2)

round(drop1(reliab.glmm, test="Chisq"),3)

#fixed effect for rater not significant, not suggesting significant disagreement 
#between coders
#   Estimate Std. Error z value Pr(>|z|)
#(Intercept)      -0.16       0.19   -0.83     0.41
#raterrecoding     0.00       0.08   -0.01     0.99

#       npar    AIC LRT Pr(Chi)
#<none>      3561.8            
#rater     1 3559.8   0   0.989
```
